--Họ và tên: GiongfNef
--Lớp: Trường Đời
--Bài tập tuần thứ 1 ngày 22/09/2021

CREATE DATABASE uit_qlgv;
DROP DATABASE uit_qlgv
USE uit_qlgv

/* Phan1*/

-- NHỮNG DỮ LIỆU MÌNH CREATE LÀ NVARCHAR DO GV BỘ MÔN YÊU CẦU, TÙY VÀO YÊU CẦU CỦA GV CÁC BẠN SET VARCHAR HOẶC NVARCHAR NHÉ !

-- CÂU 1 : Tạo quan hệ và khai báo tất cả các ràng buộc khóa chính, khóa ngoại. Thêm vào 3 thuộc tính
-- GHICHU, DIEMTB, XEPLOAI cho quan hệ HOCVIEN.


CREATE TABLE KHOA(
	MAKHOA VARCHAR(4), -- Thuộc tính khóa
	TENKHOA NVARCHAR(40), -- để lưu unicode
	NGTLAP SMALLDATETIME,
	TRGKHOA CHAR(4), -- Thuộc tính khóa
	PRIMARY KEY(MAKHOA)
)

CREATE TABLE MONHOC(
	MAMH VARCHAR(10), -- Thuộc tính khóa
	TENMH NVARCHAR(40), -- để lưu unicode
	TCLT TINYINT, -- Thuộc tính khóa
	TCTH TINYINT, -- Thuộc tính khóa
	MAKHOA VARCHAR(4),
	PRIMARY KEY(MAMH)
)

CREATE TABLE DIEUKIEN(
	MAMH VARCHAR(10),
	MAMH_TRUOC VARCHAR(10),
)

CREATE TABLE GIAOVIEN(
	MAGV CHAR(4), -- Thuộc tính khóa
	HOTEN NVARCHAR(40), -- để lưu unicode
	HOCVI NVARCHAR(10), -- để lưu unicode
	HOCHAM NVARCHAR(10), -- để lưu unicode
	GIOITINH NVARCHAR(3),-- để lưu unicode
	NGSINH SMALLDATETIME,
	NGVL SMALLDATETIME,
	HESO NUMERIC(4,2),
	MUCLUONG MONEY,
	MAKHOA VARCHAR(4),
	PRIMARY KEY(MAGV)
)

CREATE TABLE LOP(
	MALOP CHAR(3), -- Thuộc tính khóa
	TENLOP NVARCHAR(40), -- Thuộc tính khóa
	TRGLOP CHAR(5), -- Thuộc tính khóa
	SISO TINYINT,
	MAGVCN CHAR(4)
	PRIMARY KEY(MALOP)
)

CREATE TABLE HOCVIEN(
	MAHV CHAR(5), -- Thuộc tính khóa
	HO NVARCHAR(40), -- để lưu unicode
	TEN NVARCHAR(10), -- để lưu unicode
	NGSINH SMALLDATETIME,
	GIOITINH NVARCHAR(3), --để lưu unicode
	NOISINH NVARCHAR(40), --để lưu unicode
	MALOP CHAR(3)
	PRIMARY KEY(MAHV)
)

CREATE TABLE GIANGDAY(
	MALOP CHAR(3), -- Thuộc tính khóa
	MAMH VARCHAR(10), -- Thuộc tính khóa
	MAGV CHAR(4), -- Thuộc tính khóa
	HOCKY TINYINT,
	NAM SMALLINT,
	TUNGAY SMALLDATETIME,
	DENNGAY SMALLDATETIME,
)

CREATE TABLE KETQUATHI(
    MAHV CHAR(5), -- Thuộc tính khóa
	MAMH VARCHAR(10), -- Thuộc tính khóa
	LANTHI TINYINT, -- Thuộc tính khóa
	TGTHI SMALLDATETIME,
	DIEM NUMERIC,
	KQUA NVARCHAR(10), --để lưu unicode
	
)
-- Khóa ngoại

ALTER TABLE dbo.KHOA
--DROP FK_KHOA_TRGKHOA
ADD CONSTRAINT FK_KHOA_TRGKHOA FOREIGN KEY(TRGKHOA) REFERENCES dbo.GIAOVIEN(MAGV)

ALTER TABLE dbo.MONHOC
--DROP FK_MONHOC_MAKHOA
ADD CONSTRAINT FK_MONHOC_MAKHOA FOREIGN KEY(MAKHOA) REFERENCES dbo.KHOA(MAKHOA)

ALTER TABLE dbo.DIEUKIEN
--DROP FK_DIEUKIEN_MAMH
ADD CONSTRAINT FK_DIEUKIEN_MAMH FOREIGN KEY(MAMH) REFERENCES dbo.MONHOC(MAMH)

ALTER TABLE dbo.DIEUKIEN
--DROP FK_MAMH_TRUOC
ADD CONSTRAINT FK_MAMH_TRUOC FOREIGN KEY(MAMH_TRUOC) REFERENCES dbo.MONHOC(MAMH)

ALTER TABLE dbo.GIAOVIEN
--DROP FK_GIAOVIEN_MAKHOA
ADD CONSTRAINT FK_GIAOVIEN_MAKHOA FOREIGN KEY(MAKHOA) REFERENCES dbo.KHOA(MAKHOA)

ALTER TABLE dbo.LOP
--DROP FK_LOP_TRGLOP
ADD CONSTRAINT FK_LOP_TRGLOP FOREIGN KEY(TRGLOP) REFERENCES dbo.HOCVIEN(MAHV)

ALTER TABLE dbo.LOP
--DROP FK_LOP_MAGVCN
ADD CONSTRAINT FK_LOP_MAGVCN FOREIGN KEY(MAGVCN) REFERENCES dbo.GIAOVIEN(MAGV)

ALTER TABLE dbo.HOCVIEN
--DROP FK_HOCVIEN_MALOP
ADD CONSTRAINT FK_HOCVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES dbo.LOP(MALOP)

ALTER TABLE dbo.GIANGDAY
--DROP FK_GIANGVIEN_MALOP
ADD	 CONSTRAINT FK_GIANGVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES dbo.LOP(MALOP)

ALTER TABLE dbo.GIANGDAY
--DROP FK_GIANG_VIEN
ADD CONSTRAINT FK_GIANG_VIEN FOREIGN KEY(MAMH) REFERENCES dbo.MONHOC(MAMH)

ALTER TABLE dbo.KETQUATHI 
--DROP FK_KETQUATHI_MAHV
ADD CONSTRAINT FK_KETQUATHI_MAHV FOREIGN KEY(MAHV) REFERENCES dbo.HOCVIEN(MAHV)

ALTER TABLE dbo.KETQUATHI -- this
--DROP FK_KETQUATHI_MAMH
ADD	 CONSTRAINT FK_KETQUATHI_MAMH FOREIGN KEY(MAMH) REFERENCES dbo.MONHOC(MAMH)

-- thêm cột cho bản HOCVIEN

ALTER TABLE dbo.HOCVIEN
ADD	GHICHU VARCHAR(50)

ALTER TABLE dbo.HOCVIEN
ADD DIEMTB NUMERIC(4,2)

ALTER TABLE dbo.HOCVIEN
ADD XEOLOAI NVARCHAR(50)

-- Câu 2: Mã học viên là một chuỗi 5 ký tự, 3 ký tự đầu là mã lớp, 2 ký tự cuối cùng là số thứ tự học
--viên trong lớp. VD: “K1101”

-- Kiểm tra 3 kí tự đầu là mã lớp, 2 kí tự cuối là number

ALTER TABLE dbo.HOCVIEN
ADD CONSTRAINT CHECK_MAHV CHECK(LEN(MAHV) = 5 AND SUBSTRING(MAHV, 1,3) = MALOP AND ISNUMERIC(SUBSTRING(MAHV,4,2)) = 1)

-- ('K1212','Le Thi Phi','Yen','12/3/1986','Nữ','TpHCM','K13')

-- Câu3: Thuộc tính GIOITINH chỉ có giá trị là “Nam” hoặc “Nu”.

ALTER TABLE dbo.HOCVIEN
--DROP CHECK_HOCVIEN_GIOITINH
ADD CONSTRAINT CHECK_HOCVIEN_GIOITINH CHECK(GIOITINH IN (N'Nam', N'Nữ'))

ALTER TABLE dbo.GIAOVIEN
--DROP CHECK_GIAOVIEN_GIOITINH
ADD CONSTRAINT CHECK_GIAOVIEN_GIOITINH CHECK(GIOITINH IN (N'Nam', N'Nữ'))

-- Câu4 :Điểm số của một lần thi có giá trị từ 0 đến 10 và cần lưu đến 2 số lẽ (VD: 6.22).

ALTER TABLE dbo.KETQUATHI
--DROP CHECK_KETQUATHI
ADD CONSTRAINT CHECK_KETQUATHI CHECK(DIEM BETWEEN 0 AND 10)


-- Phần 2
-- Cập nhật dữ liệu


SET DATEFORMAT DMY
-- insert KHOA

-- # THỨ TỰ INSERT MÌNH VẪN CHƯA SẮP XẾP LẠI,CÁC BẠN XẾP LẠI CHO ĐÚNG MỚI EXECUTE TỪ TRÊN XUỐNG ĐƯỢC (TỪ RÀNG BUỘC -s> INSERT)


INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('KHMT', N'Khoa học máy tính', '7/6/2005', 'GV01')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('HTTT', N'Hệ thống thông tin', '7/6/2005', 'GV02')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('CNPM', N'Công nghệ phần mềm', '7/6/2005', 'GV04')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('MTT', N'Mạng và truyền thống', '20/10/2005', 'GV03')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('KTMT', N'Kỹ thuật máy tính', '20/12/2005', 'GV04')

-- insert LOP

INSERT INTO dbo.LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K11', N'Lớp 1 khoa 1', 'K1108', '11', 'GV07')

INSERT INTO dbo.LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K12', N'Lớp 2 khoa 1', 'K1205', '12', 'GV09')

INSERT INTO dbo.LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K13', N'Lớp 3 khoa 1', 'K1305', '12', 'GV14')

-- MONHOC

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('THDC', N'Tin học đại cương', '4','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CTRR', N'Cấu trúc rời rạc', '5','0','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CSDL', N'Cơ sở dữ liệu', '3','1','HTTT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CTDLGT', N'Cấu trúc dữ liệu và giải thuật', '3','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('PTTKTT', N'Phân tích thiết kế thuật toán', '0','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('DHMT', N'Độ họa máy tính', '3','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('KTMT', N'Kiến trúc máy tính', '3','0','KTMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('TKCSDL', N'Thiết kế cơ sở dữ liệu', '3','1','HTTT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('PTTKHTTT', N'Phân tích thiết kế hệ thống thông tin', '4','1','HTTT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('HDH', N'Hệ điều hành', '4','0','KTMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('NMCNPM', N'Nhập môn công nghệ phần mềm', '3','0','CNPM')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('LTCFW', N'Lập trình C for win', '3','1','CNPM')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('LTHDT', N'Lập trình hướng đối tượng', '3','1','CNPM')

-- GIANGDAY

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','THDC','GV07','1','2006','2/1/2006','12/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','THDC','GV06','1','2006','2/1/2006','12/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','THDC','GV15','1','2006','2/1/2006','12/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CTRR','GV02','1','2006','9/1/2006','17/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CTRR','GV02','1','2006','9/1/2006','17/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CTRR','GV08','1','2006','9/1/2006','17/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CSDL','GV05','2','2006','1/6/2006','15/7/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CSDL','GV09','2','2006','1/6/2006','15/7/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CTDLGT','GV15','2','2006','1/6/2006','15/7/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CSDL','GV05','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','DHMT','GV07','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CTDLGT','GV15','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CTDLGT','GV15','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','HDH','GV04','1','2007','2/1/2007','18/3/2007')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','HDH','GV04','1','2007','2/1/2007','20/3/2007')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','DHMT','GV07','1','2007','18/2/2007','20/3/2007')

--GIAOVIEN

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV01',N'Hồ Thanh Sơn','PTS','GS',N'Nam','2/5/1950','11/1/2004','5.00','2,250,000','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV02',N'Trần Tam Thanh','TS','PGS',N'Nam','17/12/1965','20/4/2004','4.50','2,025,000','HTTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV03',N'Do Nghiệm Phùng','TS','GS',N'Nữ','1/8/1950','23/9/2004','4.00','1,800,000','CNPM')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV04',N'Trần Nam Sơn','TS','PGS',N'Nam','22/2/1961','12/1/2005','4.50','2,025,000','KTMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV05',N'Mai Thanh Danh','ThS','GV',N'Nam','12/3/1958','12/1/2005','3.0','1,350,000','HTTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV06',N'Trần Đoan Hùng','TS','GV',N'Nam','11/3/1953','12/1/2005','4.50','2,250,000','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV07',N'Nguyễn Minh Tiến','ThS',N'GV','Nam','23/11/1971','1/3/2005','4.00','760,500','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV08',N'Lê Thị Trân','KS','NULL',N'Nữ','26/3/1974','1/3/2005','1.69','760,500','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV09',N'Nguyễn Tố Lan','ThS','GV',N'Nữ','17/7/1972','1/3/2005','4.00','1,800,000','HTTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV10',N'Lê Trần Anh Loan','KS','NULL',N'Nữ','17/7/1972','1/3/2005','1.86','837,000','CNPM')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV11',N'Hồ Thanh Tùng','CN','GV',N'Nam','12/1/1980','15/5/2005','2.67','1,201,500','MTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV12',N'Trần Văn Anh','CN','NULL',N'Nữ','29/3/1981','15/5/2005','1.69','760,500','CNPM')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV13',N'Nguyễn Linh Đan','CN','NULL',N'Nữ','23/5/1980','15/5/2005','1.69','765,500','KTMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV14',N'Trương Minh Châu','ThS','GV',N'Nữ','30/11/1976','15/5/2005','3.00','1,350,000','MTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV15',N'Lê Hà Thành','ThS','GV',N'Nam','4/5/1978','15/5/2005','3.00','1,350,000','KHMT')

--DIEUKIEN

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('CSDL','CTRR')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('CSDL','CTDLGT')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('CTDLGT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('PTTKTT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('PTTKTT','CTDLGT')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('DHMT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('LTHDT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('PTTKHTTT','CSDL')

-- KETQUATHI

-- bảng 1:
INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','CSDL','1','20/7/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','CTDLGT','1','28/12/2006','9.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','THDC','1','20/5/2006','9.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','CTRR','1','13/5/2006','9.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CSDL','1','20/7/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CSDL','2','27/7/2006','4.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CSDL','3','10/8/2006','4.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','1','28/12/2006','4.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','2','5/1/2007','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','3','15/1/2007','6.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','THDC','1','20/5/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTRR','1','13/5/2006','7.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CSDL','1','20/7/2006','3.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CSDL','2','27/7/2006','8.25',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CTDLGT','1','28/12/2006','7.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','THDC','1','20/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CTRR','1','13/5/2006','6.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CSDL','1','20/7/2006','3.75',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTDLGT','1','28/12/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','THDC','1','20/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTRR','1','13/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTRR','2','20/5/2006','3.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTRR','3','30/6/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','CSDL','1','20/7/2006','6.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','CTDLGT','1','28/12/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','THDC','1','20/5/2006','8.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','CTRR','1','13/5/2006','9.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CSDL','1','20/7/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTDLGT','1','28/12/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTDLGT','2','5/1/2007','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','THDC','1','20/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','THDC','2','27/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTRR','1','13/5/2006','3.00',N'Không Đạt')

-- bảng 2:

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTRR','2','20/5/2006','4.00', N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTRR','3','30/6/2006','6.25', N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','CSDL','1','20/7/2006','9.25',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','CTDLGT','1','28/12/2006','9.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','THDC','1','20/5/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','CTRR','1','13/5/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','CSDL','1','20/7/2006','8.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','CTDLGT','1','28/12/2006','6.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','THDC','1','20/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','CTRR','1','13/5/2006','6.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','CSDL','1','20/12/2006','4.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','CTDLGT','1','25/7/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','THDC','1','20/5/2006','7.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','CTRR','1','13/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','CSDL','1','20/12/2006','6.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','CTDLGT','1','25/7/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','THDC','1','20/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','CTRR','1','13/5/2006','8.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CSDL','1','20/12/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','1','25/7/2006','4.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','2','7/8/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','3','15/8/2006','4.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','THDC','1','20/5/2006','3.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTRR','1','13/5/2006','3.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTRR','2','20/5/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','CSDL','1','20/12/2006','7.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','CTDLGT','1','25/7/2006','9.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','THDC','1','20/5/2006','5.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','CTRR','1','13/5/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','CSDL','1','20/12/2006','9.25',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','CTDLGT','1','25/7/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','THDC','1','20/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','CTRR','1','13/5/2006','10.00',N'Đạt')

--HOCVIEN

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1101',N'Nguyễn Văn','An','27/1/1986',N'Nam',N'TpHCM','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1102',N'Trần Ngọc','Han','14/3/1986',N'Nữ',N'Kiên Giang','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1103',N'Ha Duy','Lap','18/4/1986',N'Nam',N'Nghệ An','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1104',N'Trần Ngọc','Linh','30/3/1986',N'Nữ',N'Tây Ninh','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1105',N'Trần Minh','Long','27/2/1986',N'Nam',N'TpHCM','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1106',N'Lê Nhat','Minh','24/1/1986',N'Nam',N'TpHCM','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1107',N'Nguyễn Nhu','Nhut','27/1/1986',N'Nam',N'Hà Nội','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1108',N'Nguyễn Manh','Tam','27/2/1986',N'Nam',N'Kiên Giang','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1109',N'Phan Thi Thanh','Tam','27/1/1986',N'Nữ',N'Vĩnh Long','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1110',N'Lê Hoai','Thuong','5/2/1986',N'Nữ',N'Cần Thơ','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1111',N'Lê Ha','Vinh','25/12/1986',N'Nam',N'Vĩnh Long','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1201',N'Nguyễn Van','B','11/2/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1202',N'Nguyễn Thi Kim','Duyen','18/1/1986',N'Nữ',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1203',N'Trần Thi Kim','Duyen','17/9/1986',N'Nữ',N'Đồng Nai','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1204',N'Trường My','Hanh','19/5/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1205',N'Nguyễn Thanh','Nam','17/4/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1206',N'Nguyễn Thi Truc','Thanh','4/3/1986',N'Nữ',N'Kiên Giang','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1207',N'Trần Thi Bich','Thuy','8/2/1986',N'Nữ',N'Nghệ An','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1208',N'Huỳnh Thi Kim','Triệu','8/4/1986',N'Nữ',N'Tây Ninh','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1209',N'Phạm Thanh','Triệu','23/2/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1210',N'Ngô Thanh','Tuan','14/2/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1211',N'Do Thi','Xuan','9/3/1986',N'Nữ',N'Hà Nội','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1212',N'Le Thi Phi','Yen','12/3/1986',N'Nữ',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1301',N'Nguyễn Thi Kim','Cuc','9/6/1986',N'Nữ',N'Kiên Giang','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1302',N'Trương Thi My','Hien','18/3/1986',N'Nữ',N'Nghệ An','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1303',N'Lê Duc','Hien','21/3/1986',N'Nam',N'Tây Ninh','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1304',N'Lê Quang','Hien','18/4/1986',N'Nam',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1305',N'Lê Thi','Huong','27/3/1986',N'Nữ',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1306',N'Nguyễn Thai','Huu','30/3/1986',N'Nam',N'Hà Nội','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1307',N'Trần Minh','Man','28/5/1986',N'Nam',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1308',N'Nguyễn Hieu','Nghia','8/4/1986',N'Nam',N'Kiên Giang','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1309',N'Nguyễn Trung','Nghia','18/1/1987',N'Nam',N'Nghệ An','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1310',N'Trần Thi Hong','Tham','22/4/1986',N'Nữ',N'Tây Ninh','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1311',N'Trần Minh','Thuc','4/4/1986',N'Nam',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1312',N'Nguyễn Thi Kim','Yen','7/9/1986',N'Nữ',N'TpHCM','K13')



--------------------------------------------------------------------- BUỔI 2 ----------------------------------------------------------------------------- 

USE uit_qlgv

-- Update data TRUOGKHOA
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV05'
WHERE MAKHOA = 'KHMT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV06'
WHERE MAKHOA = 'HTTT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV04'
WHERE MAKHOA = 'CNPM'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV03'
WHERE MAKHOA = 'MTT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV02'
WHERE MAKHOA = 'KTMT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV01'
WHERE MAKHOA = 'KTMT'

-- Update data LOP
UPDATE dbo.LOP
SET TRGLOP = 'GV08'
WHERE MALOP = 'KTMT'
UPDATE dbo.LOP
SET TRGLOP = 'GV07'
WHERE MALOP = 'KTMT'
UPDATE dbo.LOP 
SET TRGLOP = 'GV09'
WHERE MALOP = 'KTMT'

-- DELETE 
DELETE 
FROM dbo.HOCVIEN 
WHERE MAHV = 'K1312'

DELETE 
FROM dbo.HOCVIEN 

-- Sellect data
SELECT * FROM dbo.KHOA

SELECT TENKHOA, NGTLAP 
FROM dbo.KHOA

SELECT * 
FROM dbo.HOCVIEN

SELECT * 
FROM dbo.HOCVIEN
WHERE MALOP = 'K12'

SELECT * 
FROM dbo.HOCVIEN
WHERE NOISINH IN( 'TpHCM' , 'Kien Giang')

SELECT CONCAT(HO,' ',TEN), GIOITINH, NOISINH, MALOP
FROM dbo.HOCVIEN
WHERE NOISINH IN( 'TpHCM' , 'Kien Giang')
-- Select and sort
SELECT *
FROM dbo.KETQUATHI
WHERE DIEM >= 5
ORDER BY DIEM DESC
-- Phần 2: Ngôn ngữ thao tác dữ liệu (Data Manipulation Language):

--Câu 1: Tăng hệ số lương thêm 0.2 cho những giáo viên là trưởng khoa.
SELECT * FROM dbo.KHOA
UPDATE dbo.GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (SELECT TRGKHOA FROM dbo.KHOA)
/* Câu 2: CÂU 2 CẬP NHẬT GIÁ TRỊ ĐIỂM TRUNG BÌNH TẤT CẢ MÔN HỌC CỦA MỖI HỌC VIÊN TẤT CẢ ĐIỂM ĐỀU CÓ HỆ SỐ 1 CHỈ
LẤY ĐIỂM LẦN THI SAU CÙNG */

UPDATE dbo.HOCVIEN
SET DIEMTB = ( 
		SELECT AVG(DIEM) -- Tính điểm trung bình
		FROM dbo.KETQUATHI
		WHERE LANTHI = ( SELECT MAX(LANTHI) -- Chọn lần thi lớn nhất
						 FROM dbo.KETQUATHI
						 WHERE MAHV = dbo.KETQUATHI.MAHV -- Các MAHV có trong KETQUATHI
						 GROUP BY MAHV ) -- Nhóm thành từng group
		GROUP BY MAHV
		HAVING MAHV = KETQUATHI.MAHV
		     )



/* Câu 3: CÂU 2 CẬP NHẬT GIÁ TRỊ ĐIỂM TRUNG BÌNH TẤT CẢ MÔN HỌC CỦA MỖI HỌC VIÊN TẤT CẢ ĐIỂM ĐỀu CÓ HỆ SỐ 1 CHỈ
LẤY ĐIỂM LẦN THI SAU CÙNG */
UPDATE dbo.HOCVIEN
SET GHICHU = 'CAMTHI'
WHERE EXISTS(SELECT * FROM dbo.KETQUATHI
				WHERE ( LANTHI = '3' AND DIEM < 5 ))

-- Câu 4: Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN như sau: 
-- Nếu DIEMTB >= 9 thì XEPLOAI = ”XS”
-- Nếu 8 <= DIEMTB < 9 thì XEPLOAI = “G”
-- Nếu 6.5 <= DIEMTB < 8 thì XEPLOAI = “K”
-- Nếu 5 <= DIEMTB < 6.5 thì XEPLOAI = “TB” 
-- Nếu DIEMTB < 5 thì XEPLOAI = ”Y” 

-- Cách 1:
UPDATE dbo.HOCVIEN
SET XEOLOAI = 'XS'
WHERE DIEMTB >= 9

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'G'
WHERE 8 <= DIEMTB AND DIEMTB < 9

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'K'
WHERE 6.5 <= DIEMTB AND DIEMTB < 8

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'TB'
WHERE 5 <= DIEMTB AND DIEMTB < 6.5

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'Y'
WHERE DIEMTB < 5

-- Cách 2:
UPDATE dbo.HOCVIEN
SET XEOLOAI =
(
	CASE 
		WHEN DIEMTB >= 9 THEN 'XS'
		WHEN 8 <= DIEMTB AND DIEMTB < 9 THEN 'G'
		WHEN 6.5 <= DIEMTB AND DIEMTB < 8 THEN 'K'
		WHEN 5 <= DIEMTB AND DIEMTB < 6.5 THEN 'TB'
		WHEN DIEMTB < 5 THEN 'Y'
	END	
)

-- Phần 3 Ngôn ngữ truy vấn dữ liệu:

-- Câu 1: In ra danh sách (mã học viên, họ tên, ngày sinh, mã lớp) lớp trưởng của các lớp.
-- Cách 1:
SELECT MAHV,CONCAT(HO, ' ',TEN) AS HOTEN,NGSINH, dbo.HOCVIEN.MALOP 
FROM dbo.HOCVIEN,dbo.LOP
WHERE dbo.HOCVIEN.MAHV = dbo.LOP.TRGLOP

-- Cách 2:
SELECT MAHV, CONCAT(HO, ' ',TEN) AS HOTEN, NGSINH, dbo.HOCVIEN.MALOP
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON dbo.HOCVIEN.MAHV = dbo.LOP.TRGLOP

-- Cách 3:
SELECT MAHV,CONCAT(HO, ' ',TEN) AS HOTEN,NGSINH, dbo.HOCVIEN.MALOP 
FROM dbo.HOCVIEN
WHERE MAHV IN (SELECT TRGLOP FROM dbo.LOP)

-- Câu 2:In ra bảng điểm khi thi (mã học viên, họ tên , lần thi, điểm số) môn CTRR của lớp “K12”,
-- Sắp xếp theo tên, họ học viên.
-- Cách1
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN,LANTHI, DIEM
FROM dbo.HOCVIEN,dbo.KETQUATHI
WHERE MAMH = 'CTRR' AND dbo.HOCVIEN.MALOP = 'K12' AND dbo.HOCVIEN.MAHV = dbo.KETQUATHI.MAHV
ORDER BY HO,TEN 

-- Cách 2
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN,LANTHI, DIEM
FROM dbo.KETQUATHI
INNER JOIN dbo.HOCVIEN ON dbo.KETQUATHI.MAHV = dbo.HOCVIEN.MAHV
WHERE MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY TEN, HO

--Câu 3: In ra danh sách những học viên (mã học viên, họ tên) và những môn học mà học viên đó thi
--lần thứ nhất đã đạt.

SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN, dbo.MONHOC.TENMH
FROM dbo.KETQUATHI
INNER JOIN dbo.MONHOC ON dbo.MONHOC.MAMH = dbo.KETQUATHI.MAMH 
INNER JOIN  dbo.HOCVIEN ON dbo.KETQUATHI.MAHV = dbo.HOCVIEN.MAHV 
WHERE LANTHI = '1' AND KQUA = N'Đạt'

--Câu 4: In ra danh sách học viên (mã học viên, họ tên) của lớp “K11” thi môn CTRR không đạt (ở
--lần thi 1).

SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE dbo.HOCVIEN.MALOP = 'K11' AND LANTHI = '1' AND KQUA = N'Không Đạt'


--------------------------------------------------------------------- BUỔI 3 ----------------------------------------------------------------------------- 
-- 20/10/2021

-- Phần 3

/*Câu 5: * Danh sách học viên (mã học viên, họ tên) của lớp “K” thi môn CTRR không đạt (ở tất cả
các lần thi). */

-- Cách 1: theo hướng hiểu thứ nhất
SELECT DISTINCT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' AND KQUA = N'Không Đạt'

SELECT  dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' AND KQUA = N'Không Đạt'

-- Cách 2:

SELECT  dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' 
AND NOT EXISTS ( SELECT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
			     INNER JOIN dbo.HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
				 WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' AND KQUA = N'Đạt')

-- Cách 3:
SELECT  dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' 
AND HOCVIEN.MAHV IN (SELECT DISTINCT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
					  WHERE MAHV = 'CTRR' AND KQUA = N'Không Đạt') 
										  AND dbo.KETQUATHI.MAHV NOT IN ( SELECT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
																		 WHERE MAMH = 'CTRR' AND KQUA = N'Đạt' AND LANTHI >=2)

-- Cách 4:

SELECT DISTINCT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' 
AND HOCVIEN.MAHV NOT IN (SELECT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
INNER JOIN dbo.HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE MAMH = 'CTRR' AND KQUA = NN'Đạt' AND LANTHI >= 2 )

-- Cách 5:

SELECT DISTINCT MAHV
FROM dbo.KETQUATHI
WHERE MAMH = 'CTRR' AND KQUA = N'Không Đạt'
EXCEPT
SELECT DISTINCT MAHV
FROM dbo.KETQUATHI
WHERE MAMH = 'CTRR' AND	 KQUA = N'Đạt' AND LANTHI >= 2



/*Câu 6:Tìm tên những môn học mà giáo viên có tên “Tran Tam Thanh” dạy trong học kỳ 1 năm
2006.*/		

SELECT DISTINCT dbo.MONHOC.MAMH
FROM dbo.MONHOC
INNER JOIN dbo.GIANGDAY ON dbo.MONHOC.MAMH = dbo.GIANGDAY.MAMH
INNER JOIN dbo.GIAOVIEN ON	GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = N'Trần Tam Thanh' AND HOCKY = 1 AND NAM = 2006


-- Làm thêm các lớp và GV Trần Tam Thanh đã dạy HK1 năm 2006
SELECT *
FROM dbo.MONHOC
INNER JOIN dbo.GIANGDAY ON dbo.MONHOC.MAMH = dbo.GIANGDAY.MAMH
INNER JOIN dbo.GIAOVIEN ON	GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = N'Trần Tam Thanh' AND HOCKY = 1 AND NAM = 2006

/*Câu 7:Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy
trong học kỳ 1 năm 2006.*/


SELECT dbo.MONHOC.MAMH, dbo.MONHOC.TENMH
FROM dbo.MONHOC
INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAMH = MONHOC.MAMH INNER JOIN dbo.LOP ON LOP.MALOP = GIANGDAY.MALOP
WHERE MAGV = (SELECT MAGVCN FROM dbo.LOP WHERE MALOP = 'K11')  AND HOCKY = 1 AND NAM = 2006


/*Câu 8:Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So
Du Lieu”.*/
--not yet
SELECT CONCAT(HO, ' ', TEN) AS HOTEN
FROM dbo.HOCVIEN
WHERE MAHV IN (
	SELECT TRGLOP 
	FROM dbo.LOP
	INNER JOIN dbo.GIANGDAY ON GIANGDAY.MALOP = LOP.MALOP -- kết bảng GIANGDAY và LOP
	INNER JOIN dbo.GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV-- kết bảng GIANGDAY và GIAOVIEN
	INNER JOIN dbo.MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH -- kết bảng MONHOC và GIANGDAY
	WHERE HOTEN = N'Nguyễn Tố Lan' AND TENMH = N'Cơ sở dữ liệu')
						
						
/*Câu 9: In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So
Du Lieu”.*/
SELECT MAMH, TENMH
FROM dbo.MONHOC
WHERE dbo.MONHOC.MAMH IN (SELECT MAMH_TRUOC
						  FROM dbo.DIEUKIEN
						  INNER JOIN dbo.MONHOC ON MONHOC.MAMH = DIEUKIEN.MAMH -- kết bảng MONHOC và DIEUKIEN
						  WHERE TENMH = N'Cơ sở dữ liệu') 


/*Câu 10: Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học,
tên môn học) nào.*/

SELECT MAMH, TENMH
FROM dbo.MONHOC
WHERE dbo.MONHOC.MAMH IN (SELECT dbo.DIEUKIEN.MAMH
						  FROM dbo.DIEUKIEN
						  INNER JOIN dbo.MONHOC ON MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC -- kết bảng MONHOC và DIEUKIEN
						  WHERE TENMH = N'Cấu trúc rời rạc') 




/*Câu 11: Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1
năm 2006.*/

SELECT HOTEN
FROM dbo.GIAOVIEN
WHERE MAGV IN (
	SELECT GIAOVIEN.MAGV
	FROM dbo.GIAOVIEN
	INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV -- kết bảng GIANGDAY và GIAOVIEN
	WHERE MALOP = 'K11' AND HOCKY = 1 AND NAM = 2006
	UNION
	SELECT GIAOVIEN.MAGV
	FROM dbo.GIAOVIEN
	INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV -- kết bảng GIANGDAY và GIAOVIEN
	WHERE MALOP = 'K12' AND HOCKY = 1 AND NAM = 2006
)

/*Câu 12: Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng
chưa thi lại môn này.*/

-- Cách 1:
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS	HOTEN
FROM dbo.HOCVIEN 
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
WHERE MAMH = 'CSDL' AND KQUA = N'Không Đạt' AND LANTHI <= 1 AND NOT EXISTS (SELECT * FROM dbo.KETQUATHI
																			INNER JOIN dbo.HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV -- kết bảng KETQUATHI và HOCVIEN
																			WHERE LANTHI > 1
																			)
-- Cách 2:
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS	HOTEN -- Gộp HO và TEN ở giữa có khoảng trắng
FROM dbo.HOCVIEN 
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
WHERE MAMH = 'CSDL' AND KQUA = N'Không Đạt' AND LANTHI = 1
EXCEPT
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS	HOTEN
FROM dbo.HOCVIEN 
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
WHERE MAMH = 'CSDL'AND KQUA = N'Không Đạt' AND LANTHI > 1

/*Câu 13: Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào.*/

SELECT MAGV, HOTEN
FROM dbo.GIAOVIEN
WHERE MAGV IN (SELECT DISTINCT MAGV
			   FROM dbo.GIAOVIEN
			   EXCEPT
			   SELECT DISTINCT MAGV
			   FROM dbo.GIANGDAY)

/*Câu 14: Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào
thuộc khoa giáo viên đó phụ trách.*/
SELECT MAGV, HOTEN
FROM dbo.GIAOVIEN
WHERE NOT EXISTS(SELECT * -- chọn các giáo viên được phân công giảng dạy bất kỳ môn học nào thuộc khoa giáo viên đó phụ trách
				 FROM dbo.MONHOC,dbo.GIANGDAY
				 WHERE dbo.MONHOC.MAKHOA = dbo.GIAOVIEN.MAKHOA
				 AND dbo.GIANGDAY.MAGV = dbo.GIAOVIEN.MAGV
				 AND dbo.GIANGDAY.MAMH = dbo.MONHOC.MAMH
				 )

/*Câu 15: Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat”
hoặc thi lần thứ 2 môn CTRR được 5 điểm.*/

SELECT CONCAT(HO,' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON LOP.MALOP = HOCVIEN.MALOP -- kết bảng LOP và HOCVIEN
WHERE SUBSTRING(HOCVIEN.MALOP,1,3) = 'K11' AND MAHV IN (SELECT dbo.HOCVIEN.MAHV 
										 FROM dbo.HOCVIEN
										 INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
										 WHERE LANTHI > 3 AND KQUA = N'Không Đạt'
										 UNION
									     SELECT dbo.HOCVIEN.MAHV 
										 FROM dbo.HOCVIEN
										 INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
										 WHERE MAMH = 'CTRR' AND LANTHI = 2 AND KQUA = N'Đạt')
/*Câu 16: Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm
học.*/

SELECT HOTEN
FROM dbo.GIAOVIEN
WHERE dbo.GIAOVIEN.MAGV IN (SELECT dbo.GIAOVIEN.MAGV
						    FROM dbo.GIAOVIEN
							INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV -- kết bảng GIANGDAY và GIAOVIEN
							WHERE dbo.GIANGDAY.MAMH = 'CTRR' 
							GROUP BY dbo.GIAOVIEN.MAGV, HOCKY, NAM
							HAVING COUNT(MALOP) >= 2 )

/*Câu 17: Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng).*/

SELECT *
FROM dbo.KETQUATHI
INNER JOIN dbo.HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV -- kết bảng HOCVIEN và KETQUATHI
WHERE MAMH = 'CSDL' AND  LANTHI = ( SELECT MAX(LANTHI)
									FROM dbo.KETQUATHI
									WHERE MAMH = 'CSDL' AND dbo.KETQUATHI.MAHV = dbo.HOCVIEN.MAHV 
									GROUP BY KETQUATHI.MAHV
								  )
					

/*Câu 18: Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần
thi).*/

SELECT *
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
INNER JOIN dbo.MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH -- kết bảng MONHOC và KETQUATHI
WHERE TENMH = N'Cơ sở dữ liệu' 
	  AND DIEM = 
	  (
		  SELECT MAX(DIEM) -- Chọn điểm thi cao nhất
		  FROM dbo.KETQUATHI
		  WHERE TENMH = N'Cơ sở dữ liệu' AND dbo.HOCVIEN.MAHV = dbo.KETQUATHI.MAHV -- kết KETQUATHI.MAHV với HOCVIEN.MAHV ở câu lệnh trước đó
		  GROUP BY dbo.KETQUATHI.MAHV
	   )

--phép chia
/*
SELECT *
FROM    dbo.GIANGDAY
ORDER BY MAGV

SELECT *
FROM    dbo.LOP

SELECT * FROM dbo.GIAOVIEN
WHERE NOT EXISTS (
SELECT dbo.LOP.MALOP FROM    dbo.LOP
EXCEPT
SELECT dbo.GIANGDAY.MALOP FROM dbo.GIANGDAY
WHERE dbo.GIAOVIEN.MAGV = dbo.GIANGDAY.MAGV)
*/

--------------------------------------------------------------------- BUỔI 4 ----------------------------------------------------------------------------- 
-- 03/11/2021

-- Phần 3

/*Câu 19:Khoa nào (mã khoa, tên khoa) được thành lập sớm nhất.*/
-- Bảng : KHOA

-- Cách1
USE uit_qlgv

SELECT MAKHOA, NGTLAP
FROM dbo.KHOA
WHERE MONTH(NGTLAP) = (SELECT MIN(MONTH(NGTLAP)) -- chọn tháng bé nhất
					   FROM dbo.KHOA)
	  AND	

	  DAY(NGTLAP) = (SELECT MIN(DAY(NGTLAP)) -- chọn ngày bé nhất
					   FROM dbo.KHOA)

	  AND	

	  YEAR(NGTLAP) = (SELECT MIN(YEAR(NGTLAP)) -- chọn năm bé nhất
					   FROM dbo.KHOA)

-- Cách2

SELECT MAKHOA, NGTLAP
FROM dbo.KHOA
WHERE NGTLAP = (SELECT MIN(NGTLAP)
			    FROM dbo.KHOA)

/*Câu 20: Có bao nhiêu (thống kê) giáo viên có học hàm là “GS” hoặc “PGS”.*/
-- Bảng: GIAOVIEN	

--Cách 1:
SELECT HOCHAM,COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'
GROUP BY HOCHAM

--Cách 2:
SELECT COUNT(MAGV), HOCHAM
FROM dbo.GIAOVIEN
WHERE HOCHAM = 'GS' 
GROUP BY HOCHAM
UNION
SELECT COUNT(MAGV), HOCHAM
FROM dbo.GIAOVIEN
WHERE  HOCHAM = 'PGS'
GROUP BY HOCHAM

--Cách 3:
SELECT HOCHAM,COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM IN ('PGS', 'GS')
GROUP BY HOCHAM

-- Làm thêm: (Thống kê) có bao nhiêu giảng viên chưa là GS, PSG

--Cách 1:
SELECT COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM NOT IN ('PGS', 'GS')


--Cách 2:
SELECT SUM(SOLUONG) AS NOT_PGS_GS_nef
FROM	
(SELECT HOCHAM, COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM IN ('Null', 'GV')
GROUP BY HOCHAM) AS NOT_PGS_GS

/*Câu 21: Thống kê có bao nhiêu giáo viên có học vị là “CN”, “KS”, “Ths”, “TS”, “PTS” trong mỗi
khoa.*/
-- Bảng: KHOA, GIAOVIEN

SELECT dbo.KHOA.MAKHOA,TENKHOA,HOCVI,COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
INNER JOIN dbo.KHOA ON KHOA.MAKHOA = GIAOVIEN.MAKHOA
WHERE HOCVI IN ('CN', 'KS', 'Ths', 'TS', 'PTS')
GROUP BY dbo.KHOA.MAKHOA,TENKHOA,HOCVI

-- Làm thêm: Cập nhật PTS thành TS, TS thành TSKH
UPDATE dbo.GIAOVIEN
SET HOCVI = 'TSKH'
WHERE HOCVI = 'TS'

UPDATE dbo.GIAOVIEN
SET HOCVI = 'TS'
WHERE HOCVI = 'PTS'

SELECT * FROM dbo.GIAOVIEN
-- Làm thêm:

/*Câu 22: Mỗi môn học thống kê số lượng học viên theo kết quả (đạt và không đạt).*/

-- Bảng: KETQUATHI
SELECT TENMH,KQUA ,COUNT(MAHV) AS SOLUONG
FROM dbo.KETQUATHI
INNER JOIN dbo.MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH
GROUP BY KQUA,TENMH



/*Câu 23: Tìm giáo viên (mã giáo viên, họ tên) là giáo viên chủ nhiệm của một lớp, đồng thời dạy cho
lớp đó ít nhất một môn học.*/

--Bảng : GIAOVIEN,LOP,GIANGDAY

SELECT MAGV,HOTEN
FROM dbo.GIAOVIEN
INNER JOIN dbo.LOP ON LOP.MAGVCN = GIAOVIEN.MAGV
WHERE EXISTS (SELECT * 
			  FROM dbo.GIANGDAY
			  WHERE dbo.GIANGDAY.MAGV = dbo.GIAOVIEN.MAGV
			    AND dbo.GIANGDAY.MALOP = dbo.LOP.MALOP
			  )

/*Câu 24: Tìm họ tên lớp trưởng của lớp có sỉ số cao nhất.*/

-- Bảng : LOP, HOCVIEN
SELECT CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON LOP.TRGLOP = HOCVIEN.MAHV
WHERE SISO = (SELECT MAX(SISO) FROM dbo.LOP)


/*Câu 25: Tìm họ tên những LOPTRG thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả
các lần thi).*/
-- bảng: KETQUATHI, HOCVIEN, LOP
SELECT CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON LOP.TRGLOP = HOCVIEN.MAHV
WHERE MAHV IN
(	SELECT MAHV
	FROM (
		SELECT MAHV, MAMH
		FROM dbo.KETQUATHI
		WHERE KQUA = N'Không Đạt'
		EXCEPT
		SELECT MAHV, MAMH
		FROM dbo.KETQUATHI
		WHERE KQUA = N'Đạt' AND LANTHI >= 2 
		) AS TA
		GROUP BY MAHV
		HAVING COUNT(TA.MAHV) > 3
)

-- 25.1/*Câu 25: Tìm họ tên những HOCVIEN thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả
--các lần thi).*/

SELECT CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
WHERE MAHV IN ( SELECT MAHV, COUNT(MAHV)
				FROM(
				SELECT MAHV, MAMH
				FROM dbo.KETQUATHI
				WHERE KQUA = N'Không Đạt'
				EXCEPT
				SELECT MAHV, MAMH
				FROM dbo.KETQUATHI
				WHERE KQUA = N'Đạt' AND LANTHI >= 2
				) AS T
				GROUP BY MAHV
				HAVING COUNT(T.MAHV) > 3
				)

/*Câu 26: Tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.*/

SELECT HOCVIEN.MAHV, CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
WHERE MAHV IN (SELECT MAHV 
			   FROM dbo.KETQUATHI	
			   WHERE DIEM = 9 OR DIEM = 10
			   GROUP BY MAHV
			   HAVING COUNT(DIEM) = (
									SELECT MAX(SLDIEM)
									FROM(SELECT MAHV, COUNT(DIEM) AS SLDIEM
										 FROM dbo.KETQUATHI
										 WHERE DIEM = 9 OR DIEM = 10
										 GROUP BY MAHV
									) AS T
									)
				)
/*Câu 27: Trong từng lớp, tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.*/
SELECT B.MALOP, A.MAHV, HO, TEN
FROM dbo.KETQUATHI A, dbo.HOCVIEN B
WHERE A.MAHV = B.MAHV AND (A.DIEM = 9 OR A.DIEM = 10)
GROUP BY B.MALOP, A.MAHV, HO, TEN
HAVING COUNT(MAMH) >= ALL(SELECT COUNT(A.MAMH)
						  FROM	dbo.KETQUATHI C, dbo.HOCVIEN D
						  WHERE C.MAHV = D.MAHV AND B.MALOP = D.MALOP AND (DIEM = 9 OR DIEM = 10)
						  GROUP BY C.MAHV
						)

/*Câu 28: Trong từng học kỳ của từng năm, mỗi giáo viên phân công dạy bao nhiêu môn học, bao
nhiêu lớp.*/

SELECT NAM, HOCKY, MAGV,COUNT(MAMH) AS SL_MONHOC, COUNT(MALOP) AS SL_LOP
FROM dbo.GIANGDAY
GROUP BY HOCKY,NAM,MAGV

/*Câu 29: Trong từng học kỳ của từng năm, tìm giáo viên (mã giáo viên, họ tên) giảng dạy nhiều nhất.*/
SELECT MAGV, HOTEN
FROM dbo.GIAOVIEN
WHERE MAGV IN (SELECT MAGV 
				FROM(SELECT NAM, HOCKY, MAGV,COUNT(MAMH) AS SL_MONHOC, COUNT(MALOP) AS SL_LOP
										 FROM dbo.GIANGDAY
										 GROUP BY HOCKY,NAM,MAGV
									     ) AS A
				WHERE SL_MONHOC = (
									 SELECT MAX(SL_MONHOC)
									 FROM(SELECT NAM, HOCKY, MAGV,COUNT(MAMH) AS SL_MONHOC, COUNT(MALOP) AS SL_LOP
										 FROM dbo.GIANGDAY
										 GROUP BY HOCKY,NAM,MAGV
									     ) AS T
									)
			   )


/*Câu 30: Tìm môn học (mã môn học, tên môn học) có nhiều học viên thi không đạt (ở lần thi thứ 1) nhất
nhất.*/
SELECT KQ.MAMH, TENMH, COUNT(KQ.MAMH) AS SL
FROM dbo.KETQUATHI KQ, dbo.MONHOC MH
WHERE KQ.MAMH = MH.MAMH AND KQ.KQUA = N'Không Đạt' AND KQ.LANTHI = 1
GROUP BY KQ.MAMH, MH.TENMH

HAVING COUNT(KQ.MAMH) >= ALL(SELECT COUNT(MAHV)
							FROM dbo.KETQUATHI
							WHERE KQUA = N'Không Đạt' AND LANTHI = 1
							GROUP BY MAMH
							)

/*Câu 31: Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi thứ 1).*/

SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI
							WHERE KQUA = N'Không Đạt' AND LANTHI = 1 AND dbo.KETQUATHI.MAHV = MAHV)

/*Câu 32: * Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi sau cùng).*/
SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI T1
							WHERE KQUA = N'Không Đạt' AND LANTHI = (SELECT MAX(LANTHI)
																	FROM dbo.KETQUATHI T2 
																	WHERE T1.MAHV = T2.MAHV
																	)

							AND dbo.KETQUATHI.MAHV = MAHV)


/*Câu 33: * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi thứ 1).*/

SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI
							WHERE KQUA = N'Không Đạt' AND LANTHI = 1 AND dbo.KETQUATHI.MAHV = MAHV)

/*Câu 34: * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi sau cùng).*/
SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI T1
							WHERE KQUA = N'Không Đạt' AND LANTHI = (SELECT MAX(LANTHI)
																	FROM dbo.KETQUATHI T2 
																	WHERE T1.MAHV = T2.MAHV
																	)

							AND dbo.KETQUATHI.MAHV = MAHV)

/*Câu 35: ** Tìm học viên (mã học viên, họ tên) có điểm thi cao nhất trong từng môn (lấy điểm ở lần
thi sau cùng).*/
SELECT MaMH, MaHV, HoTen
FROM
(
	SELECT
		MaMH, HocVien.MaHV, (Ho+' '+Ten) HoTen, RANK() OVER (PARTITION BY MaMH ORDER BY MAX(Diem) DESC) AS XepHang
	FROM
		HocVien, KetQuaThi
	WHERE
		HocVien.MaHV = KetQuaThi.MaHV
		AND LanThi = (SELECT MAX(LanThi) FROM KetQuaThi WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
	GROUP BY
		MaMH, HocVien.MaHV, Ho, Ten
) AS A
WHERE XepHang = 1

--------------------------------------------------------------------- BUỔI 5 ----------------------------------------------------------------------------- 
--17/11/2021
-- Phần 1:
/*Câu 5: Kết quả thi là “Dat” nếu điểm từ 5 đến 10 và “Khong dat” nếu điểm nhỏ hơn 5.*/
-- Bảng: KETQUATHI

ALTER TABLE dbo.KETQUATHI
ADD CONSTRAINT CHK_KQUA CHECK ((KQUA = N'Đạt' AND DIEM >= 5) OR (KQUA = N'Không Đạt' AND DIEM < 5))


/*Câu 6: Học viên thi một môn tối đa 3 lần.*/
-- Bảng: KETQUATHI
ALTER TABLE dbo.KETQUATHI
ADD CONSTRAINT CHECK_LANTHI CHECK (LANTHI <= 3)

/*Câu 7: Học kỳ chỉ có giá x`trị từ 1 đến 3.*/
-- Bảng: GIANGDAY
ALTER TABLE dbo.GIANGDAY
ADD CONSTRAINT CHECK_HOCKY CHECK (HOCKY BETWEEN 1 AND 3)

/*Câu 8: Học vị của giáo viên chỉ có thể là “CN”, “KS”, “Ths”, ”TS”, ”PTS”.*/
-- Bảng: GIAOVIEN

ALTER TABLE dbo.GIAOVIEN
ADD CONSTRAINT CHECK_HOCVI CHECK (HOCVI = 'CN' OR HOCVI = 'KS' OR HOCVI = 'Ths' OR HOCVI = 'TS' OR HOCVI = 'PTS')

ALTER TABLE dbo.GIAOVIEN
ADD CONSTRAINT CHECK_HOCVIne CHECK (HOCVI IN ('CN','KS','Ths','TS','PTS'))

/*Câu 9: Lớp trưởng của một lớp phải là học viên của lớp đó.*/
-- INSERT, UPDATE

DECLARE @TEN_BIEN INT, @CHUOI VARCHAR(20);
DECLARE @BIEN INT = 20;

SET @TEN_BIEN = 10;

PRINT 'Hello';
PRINT ('Hello');
PRINT @BIEN
PRINT @TEN_BIEN

CREATE TRIGGER TRG_LOP_LOPTRUONG
ON LOP
FOR INSERT,UPDATE
AS
BEGIN 
	DECLARE @MAHV CHAR(5), @TRGLOP CHAR(5), @MALOP CHAR(3)
	
	SELECT @TRGLOP = TRGLOP, @MALOP = MALOP
	FROM inserted

	SELECT @MAHV = MAHV
	FROM dbo.HOCVIEN
	WHERE MAHV = @TRGLOP AND @MALOP = MALOP

	IF (@MAHV <> @TRGLOP)
		BEGIN	
			PRINT 'Đã xãy ra lỗi. Lớp trưởng phải là thành viên của lớp '
			ROLLBACK TRANSACTION -- sử dụng để trao trả Transaction về trạng thái trước khi có thay đổi mà chưa được lưu tới Database
		END
	ELSE	
		PRINT 'Thành Công'
END

/*Câu 10: Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”.*/
-- INSERT, UPDATE
-- bảng: KHOA, GIAOVIEN

CREATE TRIGGER TRG_GIAOVIEN_TRUONGKHOA
ON KHOA
FOR INSERT, UPDATE
AS
BEGIN 
	DECLARE	@MAGV CHAR(4), @MAKHOA CHAR(4), @TRG_KHOA CHAR(4)

	SELECT @MAKHOA = MAKHOA, @TRG_KHOA = TRGKHOA
	FROM inserted

	SELECT @MAGV = MAGV
	FROM dbo.GIAOVIEN
	WHERE MAKHOA = @MAKHOA AND MAGV = @TRG_KHOA AND HOCVI IN ('TS', 'TSKH')

	IF (@MAGV <> @TRG_KHOA)
		BEGIN
			PRINT 'Xảy ra lỗi. Trưởng khoa phải là GV của Khoa và có học vị là TS hoặ TSKH'
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT'Thành công'
END

/*Câu 11: Học viên ít nhất là 18 tuổi.*/
-- Bảng: HOCVIEN
-- N0w - NGSINH >= 18

ALTER TABLE dbo.HOCVIEN
ADD CONSTRAINT CHECK_TUOIne CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 18)


SELECT YEAR(GETDATE()) - YEAR(NGSINH)
FROM dbo.HOCVIEN


/*Câu 12: Giảng dạy một môn học ngày bắt đầu (TUNGAY) phải nhỏ hơn ngày kết thúc
(DENNGAY).*/
ALTER TABLE dbo.GIANGDAY
ADD CONSTRAINT CHECK_GIANGDAY CHECK(TUNGAY < DENNGAY)


/*Câu 13: Giáo viên khi vào làm ít nhất là 22 tuổi.*/
-- Bảng: HOCVIEN
-- N0w - NGSINH >= 22
ALTER TABLE dbo.GIAOVIEN
ADD CONSTRAINT CHECK_TUOIGV CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 22)

SELECT HOTEN,YEAR(GETDATE()) - YEAR(NGSINH)
FROM dbo.GIAOVIEN
/*Câu 14: Tất cả các môn học đều có số tín chỉ lý thuyết và tín chỉ thực hành chênh lệch nhau không
quá 3.*/


ALTER TABLE dbo.MONHOC
ADD CONSTRAINT CHECK_TINCHI CHECK(abs(TCLT - TCTH) <= 3)

SELECT TCLT , TCTH, abs(TCTH - TCLT)
FROM dbo.MONHOC


/*15. Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.*/
-- KETQUATHI*, GIANGDAY
-- NGTHI < NGKT

CREATE TRIGGER TRG_HV_THI
ON KETQUATHI
FOR INSERT
AS
BEGIN
	DECLARE @MAHV CHAR(5), @MALOP CHAR(3), @MAMH CHAR(10), @NGKT SMALLDATETIME, @NGTHI SMALLDATETIME
	
	SELECT @MAHV = inserted.MAHV, @MAMH = MAMH, @MALOP = MALOP, @NGTHI = TGTHI
	FROM inserted
	INNER JOIN	dbo.HOCVIEN ON inserted.MAHV = dbo.HOCVIEN.MAHV

	SELECT @NGKT = DENNGAY
	FROM dbo.GIANGDAY
	WHERE MALOP = @MALOP AND MAMH = @MAMH

	IF (@NGTHI > @NGKT)
		BEGIN	
			PRINT 'Ngày thi phải lớn hơn ngày kết thúc môn học'
			ROLLBACK TRANSACTION
		END
	ELSE	
		PRINT('Thành công')

END

/*16. Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.*/
--Họ và tên: Trương Văn Rồng
--Lớp: IT004.M12.ATCL.1
--Bài tập tuần thứ 1 ngày 22/09/2021

CREATE DATABASE uit_qlgv;

USE uit_qlgv

/* Phan1*/

-- CÂU 1 : Tạo quan hệ và khai báo tất cả các ràng buộc khóa chính, khóa ngoại. Thêm vào 3 thuộc tính
-- GHICHU, DIEMTB, XEPLOAI cho quan hệ HOCVIEN.

CREATE TABLE KHOA(
	MAKHOA VARCHAR(4), -- Thuộc tính khóa
	TENKHOA NVARCHAR(40), -- để lưu unicode
	NGTLAP SMALLDATETIME,
	TRGKHOA CHAR(4), -- Thuộc tính khóa
	PRIMARY KEY(MAKHOA)
)

CREATE TABLE MONHOC(
	MAMH VARCHAR(10), -- Thuộc tính khóa
	TENMH NVARCHAR(40), -- để lưu unicode
	TCLT TINYINT, -- Thuộc tính khóa
	TCTH TINYINT, -- Thuộc tính khóa
	MAKHOA VARCHAR(4),
	PRIMARY KEY(MAMH)
)

CREATE TABLE DIEUKIEN(
	MAMH VARCHAR(10),
	MAMH_TRUOC VARCHAR(10),
)

CREATE TABLE GIAOVIEN(
	MAGV CHAR(4), -- Thuộc tính khóa
	HOTEN NVARCHAR(40), -- để lưu unicode
	HOCVI NVARCHAR(10), -- để lưu unicode
	HOCHAM NVARCHAR(10), -- để lưu unicode
	GIOITINH NVARCHAR(3),-- để lưu unicode
	NGSINH SMALLDATETIME,
	NGVL SMALLDATETIME,
	HESO NUMERIC(4,2),
	MUCLUONG MONEY,
	MAKHOA VARCHAR(4),
	PRIMARY KEY(MAGV)
)

CREATE TABLE LOP(
	MALOP CHAR(3), -- Thuộc tính khóa
	TENLOP NVARCHAR(40), -- Thuộc tính khóa
	TRGLOP CHAR(5), -- Thuộc tính khóa
	SISO TINYINT,
	MAGVCN CHAR(4)
	PRIMARY KEY(MALOP)
)

CREATE TABLE HOCVIEN(
	MAHV CHAR(5), -- Thuộc tính khóa
	HO NVARCHAR(40), -- để lưu unicode
	TEN NVARCHAR(10), -- để lưu unicode
	NGSINH SMALLDATETIME,
	GIOITINH NVARCHAR(3), --để lưu unicode
	NOISINH NVARCHAR(40), --để lưu unicode
	MALOP CHAR(3)
	PRIMARY KEY(MAHV)
)

CREATE TABLE GIANGDAY(
	MALOP CHAR(3), -- Thuộc tính khóa
	MAMH VARCHAR(10), -- Thuộc tính khóa
	MAGV CHAR(4), -- Thuộc tính khóa
	HOCKY TINYINT,
	NAM SMALLINT,
	TUNGAY SMALLDATETIME,
	DENNGAY SMALLDATETIME,
)

CREATE TABLE KETQUATHI(
    MAHV CHAR(5), -- Thuộc tính khóa
	MAMH VARCHAR(10), -- Thuộc tính khóa
	LANTHI TINYINT, -- Thuộc tính khóa
	TGTHI SMALLDATETIME,
	DIEM NUMERIC,
	KQUA NVARCHAR(10), --để lưu unicode
	
)
-- Khóa ngoại

ALTER TABLE dbo.KHOA
--DROP FK_KHOA_TRGKHOA
ADD CONSTRAINT FK_KHOA_TRGKHOA FOREIGN KEY(TRGKHOA) REFERENCES dbo.GIAOVIEN(MAGV)

ALTER TABLE dbo.MONHOC
--DROP FK_MONHOC_MAKHOA
ADD CONSTRAINT FK_MONHOC_MAKHOA FOREIGN KEY(MAKHOA) REFERENCES dbo.KHOA(MAKHOA)

ALTER TABLE dbo.DIEUKIEN
--DROP FK_DIEUKIEN_MAMH
ADD CONSTRAINT FK_DIEUKIEN_MAMH FOREIGN KEY(MAMH) REFERENCES dbo.MONHOC(MAMH)

ALTER TABLE dbo.DIEUKIEN
--DROP FK_MAMH_TRUOC
ADD CONSTRAINT FK_MAMH_TRUOC FOREIGN KEY(MAMH_TRUOC) REFERENCES dbo.MONHOC(MAMH)

ALTER TABLE dbo.GIAOVIEN
--DROP FK_GIAOVIEN_MAKHOA
ADD CONSTRAINT FK_GIAOVIEN_MAKHOA FOREIGN KEY(MAKHOA) REFERENCES dbo.KHOA(MAKHOA)

ALTER TABLE dbo.LOP
--DROP FK_LOP_TRGLOP
ADD CONSTRAINT FK_LOP_TRGLOP FOREIGN KEY(TRGLOP) REFERENCES dbo.HOCVIEN(MAHV)

ALTER TABLE dbo.LOP
--DROP FK_LOP_MAGVCN
ADD CONSTRAINT FK_LOP_MAGVCN FOREIGN KEY(MAGVCN) REFERENCES dbo.GIAOVIEN(MAGV)

ALTER TABLE dbo.HOCVIEN
--DROP FK_HOCVIEN_MALOP
ADD CONSTRAINT FK_HOCVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES dbo.LOP(MALOP)

ALTER TABLE dbo.GIANGDAY
--DROP FK_GIANGVIEN_MALOP
ADD	 CONSTRAINT FK_GIANGVIEN_MALOP FOREIGN KEY(MALOP) REFERENCES dbo.LOP(MALOP)

ALTER TABLE dbo.GIANGDAY
--DROP FK_GIANG_VIEN
ADD CONSTRAINT FK_GIANG_VIEN FOREIGN KEY(MAMH) REFERENCES dbo.MONHOC(MAMH)

ALTER TABLE dbo.KETQUATHI 
--DROP FK_KETQUATHI_MAHV
ADD CONSTRAINT FK_KETQUATHI_MAHV FOREIGN KEY(MAHV) REFERENCES dbo.HOCVIEN(MAHV)

ALTER TABLE dbo.KETQUATHI -- this
--DROP FK_KETQUATHI_MAMH
ADD	 CONSTRAINT FK_KETQUATHI_MAMH FOREIGN KEY(MAMH) REFERENCES dbo.MONHOC(MAMH)

-- thêm cột cho bản HOCVIEN

ALTER TABLE dbo.HOCVIEN
ADD	GHICHU VARCHAR(50)

ALTER TABLE dbo.HOCVIEN
ADD DIEMTB NUMERIC(4,2)

ALTER TABLE dbo.HOCVIEN
ADD XEOLOAI NVARCHAR(50)

-- Câu 2: Mã học viên là một chuỗi 5 ký tự, 3 ký tự đầu là mã lớp, 2 ký tự cuối cùng là số thứ tự học
--viên trong lớp. VD: “K1101”

-- Kiểm tra 3 kí tự đầu là mã lớp, 2 kí tự cuối là number

ALTER TABLE dbo.HOCVIEN
ADD CONSTRAINT CHECK_MAHV CHECK(LEN(MAHV) = 5 AND SUBSTRING(MAHV, 1,3) = MALOP AND ISNUMERIC(SUBSTRING(MAHV,4,2)) = 1)

-- ('K1212','Le Thi Phi','Yen','12/3/1986','Nữ','TpHCM','K13')

-- Câu3: Thuộc tính GIOITINH chỉ có giá trị là “Nam” hoặc “Nu”.

ALTER TABLE dbo.HOCVIEN
--DROP CHECK_HOCVIEN_GIOITINH
ADD CONSTRAINT CHECK_HOCVIEN_GIOITINH CHECK(GIOITINH IN (N'Nam', N'Nữ'))

ALTER TABLE dbo.GIAOVIEN
--DROP CHECK_GIAOVIEN_GIOITINH
ADD CONSTRAINT CHECK_GIAOVIEN_GIOITINH CHECK(GIOITINH IN (N'Nam', N'Nữ'))

-- Câu4 :Điểm số của một lần thi có giá trị từ 0 đến 10 và cần lưu đến 2 số lẽ (VD: 6.22).

ALTER TABLE dbo.KETQUATHI
--DROP CHECK_KETQUATHI
ADD CONSTRAINT CHECK_KETQUATHI CHECK(DIEM BETWEEN 0 AND 10)


-- Phần 2
-- Cập nhật dữ liệu


SET DATEFORMAT DMY
-- insert KHOA

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('KHMT', N'Khoa học máy tính', '7/6/2005', 'GV01')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('HTTT', N'Hệ thống thông tin', '7/6/2005', 'GV02')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('CNPM', N'Công nghệ phần mềm', '7/6/2005', 'GV04')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('MTT', N'Mạng và truyền thống', '20/10/2005', 'GV03')

INSERT INTO dbo.KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('KTMT', N'Kỹ thuật máy tính', '20/12/2005', 'GV04')

-- insert LOP

INSERT INTO dbo.LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K11', N'Lớp 1 khoa 1', 'K1108', '11', 'GV07')

INSERT INTO dbo.LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K12', N'Lớp 2 khoa 1', 'K1205', '12', 'GV09')

INSERT INTO dbo.LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K13', N'Lớp 3 khoa 1', 'K1305', '12', 'GV14')

-- MONHOC

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('THDC', N'Tin học đại cương', '4','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CTRR', N'Cấu trúc rời rạc', '5','0','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CSDL', N'Cơ sở dữ liệu', '3','1','HTTT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CTDLGT', N'Cấu trúc dữ liệu và giải thuật', '3','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('PTTKTT', N'Phân tích thiết kế thuật toán', '0','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('DHMT', N'Độ họa máy tính', '3','1','KHMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('KTMT', N'Kiến trúc máy tính', '3','0','KTMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('TKCSDL', N'Thiết kế cơ sở dữ liệu', '3','1','HTTT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('PTTKHTTT', N'Phân tích thiết kế hệ thống thông tin', '4','1','HTTT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('HDH', N'Hệ điều hành', '4','0','KTMT')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('NMCNPM', N'Nhập môn công nghệ phần mềm', '3','0','CNPM')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('LTCFW', N'Lập trình C for win', '3','1','CNPM')

INSERT INTO dbo.MONHOC(MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('LTHDT', N'Lập trình hướng đối tượng', '3','1','CNPM')

-- GIANGDAY

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','THDC','GV07','1','2006','2/1/2006','12/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','THDC','GV06','1','2006','2/1/2006','12/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','THDC','GV15','1','2006','2/1/2006','12/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CTRR','GV02','1','2006','9/1/2006','17/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CTRR','GV02','1','2006','9/1/2006','17/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CTRR','GV08','1','2006','9/1/2006','17/5/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CSDL','GV05','2','2006','1/6/2006','15/7/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CSDL','GV09','2','2006','1/6/2006','15/7/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CTDLGT','GV15','2','2006','1/6/2006','15/7/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CSDL','GV05','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','DHMT','GV07','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CTDLGT','GV15','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CTDLGT','GV15','3','2006','1/8/2006','15/12/2006')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','HDH','GV04','1','2007','2/1/2007','18/3/2007')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','HDH','GV04','1','2007','2/1/2007','20/3/2007')

INSERT INTO dbo.GIANGDAY(MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','DHMT','GV07','1','2007','18/2/2007','20/3/2007')

--GIAOVIEN

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV01',N'Hồ Thanh Sơn','PTS','GS',N'Nam','2/5/1950','11/1/2004','5.00','2,250,000','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV02',N'Trần Tam Thanh','TS','PGS',N'Nam','17/12/1965','20/4/2004','4.50','2,025,000','HTTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV03',N'Do Nghiệm Phùng','TS','GS',N'Nữ','1/8/1950','23/9/2004','4.00','1,800,000','CNPM')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV04',N'Trần Nam Sơn','TS','PGS',N'Nam','22/2/1961','12/1/2005','4.50','2,025,000','KTMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV05',N'Mai Thanh Danh','ThS','GV',N'Nam','12/3/1958','12/1/2005','3.0','1,350,000','HTTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV06',N'Trần Đoan Hùng','TS','GV',N'Nam','11/3/1953','12/1/2005','4.50','2,250,000','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV07',N'Nguyễn Minh Tiến','ThS',N'GV','Nam','23/11/1971','1/3/2005','4.00','760,500','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV08',N'Lê Thị Trân','KS','NULL',N'Nữ','26/3/1974','1/3/2005','1.69','760,500','KHMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV09',N'Nguyễn Tố Lan','ThS','GV',N'Nữ','17/7/1972','1/3/2005','4.00','1,800,000','HTTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV10',N'Lê Trần Anh Loan','KS','NULL',N'Nữ','17/7/1972','1/3/2005','1.86','837,000','CNPM')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV11',N'Hồ Thanh Tùng','CN','GV',N'Nam','12/1/1980','15/5/2005','2.67','1,201,500','MTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV12',N'Trần Văn Anh','CN','NULL',N'Nữ','29/3/1981','15/5/2005','1.69','760,500','CNPM')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV13',N'Nguyễn Linh Đan','CN','NULL',N'Nữ','23/5/1980','15/5/2005','1.69','765,500','KTMT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV14',N'Trương Minh Châu','ThS','GV',N'Nữ','30/11/1976','15/5/2005','3.00','1,350,000','MTT')

INSERT INTO dbo.GIAOVIEN(MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV15',N'Lê Hà Thành','ThS','GV',N'Nam','4/5/1978','15/5/2005','3.00','1,350,000','KHMT')

--DIEUKIEN

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('CSDL','CTRR')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('CSDL','CTDLGT')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('CTDLGT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('PTTKTT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('PTTKTT','CTDLGT')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('DHMT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('LTHDT','THDC')

INSERT INTO dbo.DIEUKIEN(MAMH,MAMH_TRUOC) VALUES ('PTTKHTTT','CSDL')

-- KETQUATHI

-- bảng 1:
INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','CSDL','1','20/7/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','CTDLGT','1','28/12/2006','9.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','THDC','1','20/5/2006','9.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1101','CTRR','1','13/5/2006','9.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CSDL','1','20/7/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CSDL','2','27/7/2006','4.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CSDL','3','10/8/2006','4.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','1','28/12/2006','4.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','2','5/1/2007','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','3','15/1/2007','6.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','THDC','1','20/5/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1102','CTRR','1','13/5/2006','7.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CSDL','1','20/7/2006','3.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CSDL','2','27/7/2006','8.25',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CTDLGT','1','28/12/2006','7.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','THDC','1','20/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1103','CTRR','1','13/5/2006','6.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CSDL','1','20/7/2006','3.75',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTDLGT','1','28/12/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','THDC','1','20/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTRR','1','13/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTRR','2','20/5/2006','3.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1104','CTRR','3','30/6/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','CSDL','1','20/7/2006','6.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','CTDLGT','1','28/12/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','THDC','1','20/5/2006','8.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1201','CTRR','1','13/5/2006','9.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CSDL','1','20/7/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTDLGT','1','28/12/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTDLGT','2','5/1/2007','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','THDC','1','20/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','THDC','2','27/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTRR','1','13/5/2006','3.00',N'Không Đạt')

-- bảng 2:

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTRR','2','20/5/2006','4.00', N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1202','CTRR','3','30/6/2006','6.25', N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','CSDL','1','20/7/2006','9.25',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','CTDLGT','1','28/12/2006','9.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','THDC','1','20/5/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1203','CTRR','1','13/5/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','CSDL','1','20/7/2006','8.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','CTDLGT','1','28/12/2006','6.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','THDC','1','20/5/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1204','CTRR','1','13/5/2006','6.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','CSDL','1','20/12/2006','4.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','CTDLGT','1','25/7/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','THDC','1','20/5/2006','7.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1301','CTRR','1','13/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','CSDL','1','20/12/2006','6.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','CTDLGT','1','25/7/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','THDC','1','20/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1302','CTRR','1','13/5/2006','8.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CSDL','1','20/12/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','1','25/7/2006','4.50',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','2','7/8/2006','4.00',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','3','15/8/2006','4.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','THDC','1','20/5/2006','3.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTRR','1','13/5/2006','3.25',N'Không Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1303','CTRR','2','20/5/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','CSDL','1','20/12/2006','7.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','CTDLGT','1','25/7/2006','9.75',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','THDC','1','20/5/2006','5.50',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1304','CTRR','1','13/5/2006','5.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','CSDL','1','20/12/2006','9.25',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','CTDLGT','1','25/7/2006','10.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','THDC','1','20/5/2006','8.00',N'Đạt')

INSERT INTO dbo.KETQUATHI(MAHV,MAMH,LANTHI,TGTHI,DIEM,KQUA) VALUES('K1305','CTRR','1','13/5/2006','10.00',N'Đạt')

--HOCVIEN

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1101',N'Nguyễn Văn','An','27/1/1986',N'Nam',N'TpHCM','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1102',N'Trần Ngọc','Han','14/3/1986',N'Nữ',N'Kiên Giang','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1103',N'Ha Duy','Lap','18/4/1986',N'Nam',N'Nghệ An','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1104',N'Trần Ngọc','Linh','30/3/1986',N'Nữ',N'Tây Ninh','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1105',N'Trần Minh','Long','27/2/1986',N'Nam',N'TpHCM','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1106',N'Lê Nhat','Minh','24/1/1986',N'Nam',N'TpHCM','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1107',N'Nguyễn Nhu','Nhut','27/1/1986',N'Nam',N'Hà Nội','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1108',N'Nguyễn Manh','Tam','27/2/1986',N'Nam',N'Kiên Giang','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1109',N'Phan Thi Thanh','Tam','27/1/1986',N'Nữ',N'Vĩnh Long','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1110',N'Lê Hoai','Thuong','5/2/1986',N'Nữ',N'Cần Thơ','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1111',N'Lê Ha','Vinh','25/12/1986',N'Nam',N'Vĩnh Long','K11')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1201',N'Nguyễn Van','B','11/2/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1202',N'Nguyễn Thi Kim','Duyen','18/1/1986',N'Nữ',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1203',N'Trần Thi Kim','Duyen','17/9/1986',N'Nữ',N'Đồng Nai','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1204',N'Trường My','Hanh','19/5/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1205',N'Nguyễn Thanh','Nam','17/4/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1206',N'Nguyễn Thi Truc','Thanh','4/3/1986',N'Nữ',N'Kiên Giang','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1207',N'Trần Thi Bich','Thuy','8/2/1986',N'Nữ',N'Nghệ An','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1208',N'Huỳnh Thi Kim','Triệu','8/4/1986',N'Nữ',N'Tây Ninh','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1209',N'Phạm Thanh','Triệu','23/2/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1210',N'Ngô Thanh','Tuan','14/2/1986',N'Nam',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1211',N'Do Thi','Xuan','9/3/1986',N'Nữ',N'Hà Nội','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1212',N'Le Thi Phi','Yen','12/3/1986',N'Nữ',N'TpHCM','K12')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1301',N'Nguyễn Thi Kim','Cuc','9/6/1986',N'Nữ',N'Kiên Giang','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1302',N'Trương Thi My','Hien','18/3/1986',N'Nữ',N'Nghệ An','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1303',N'Lê Duc','Hien','21/3/1986',N'Nam',N'Tây Ninh','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1304',N'Lê Quang','Hien','18/4/1986',N'Nam',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1305',N'Lê Thi','Huong','27/3/1986',N'Nữ',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1306',N'Nguyễn Thai','Huu','30/3/1986',N'Nam',N'Hà Nội','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1307',N'Trần Minh','Man','28/5/1986',N'Nam',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1308',N'Nguyễn Hieu','Nghia','8/4/1986',N'Nam',N'Kiên Giang','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1309',N'Nguyễn Trung','Nghia','18/1/1987',N'Nam',N'Nghệ An','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1310',N'Trần Thi Hong','Tham','22/4/1986',N'Nữ',N'Tây Ninh','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1311',N'Trần Minh','Thuc','4/4/1986',N'Nam',N'TpHCM','K13')

INSERT INTO dbo.HOCVIEN(MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES ('K1312',N'Nguyễn Thi Kim','Yen','7/9/1986',N'Nữ',N'TpHCM','K13')



--------------------------------------------------------------------- BUỔI 2 ----------------------------------------------------------------------------- 

USE uit_qlgv

-- Update data TRUOGKHOA
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV05'
WHERE MAKHOA = 'KHMT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV06'
WHERE MAKHOA = 'HTTT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV04'
WHERE MAKHOA = 'CNPM'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV03'
WHERE MAKHOA = 'MTT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV02'
WHERE MAKHOA = 'KTMT'
UPDATE dbo.KHOA 
SET TRGKHOA = 'GV01'
WHERE MAKHOA = 'KTMT'

-- Update data LOP
UPDATE dbo.LOP
SET TRGLOP = 'GV08'
WHERE MALOP = 'KTMT'
UPDATE dbo.LOP
SET TRGLOP = 'GV07'
WHERE MALOP = 'KTMT'
UPDATE dbo.LOP 
SET TRGLOP = 'GV09'
WHERE MALOP = 'KTMT'

-- DELETE 
DELETE 
FROM dbo.HOCVIEN 
WHERE MAHV = 'K1312'

DELETE 
FROM dbo.HOCVIEN 

-- Sellect data
SELECT * FROM dbo.KHOA

SELECT TENKHOA, NGTLAP 
FROM dbo.KHOA

SELECT * 
FROM dbo.HOCVIEN

SELECT * 
FROM dbo.HOCVIEN
WHERE MALOP = 'K12'

SELECT * 
FROM dbo.HOCVIEN
WHERE NOISINH IN( 'TpHCM' , 'Kien Giang')

SELECT CONCAT(HO,' ',TEN), GIOITINH, NOISINH, MALOP
FROM dbo.HOCVIEN
WHERE NOISINH IN( 'TpHCM' , 'Kien Giang')
-- Select and sort
SELECT *
FROM dbo.KETQUATHI
WHERE DIEM >= 5
ORDER BY DIEM DESC
-- Phần 2: Ngôn ngữ thao tác dữ liệu (Data Manipulation Language):

--Câu 1: Tăng hệ số lương thêm 0.2 cho những giáo viên là trưởng khoa.
SELECT * FROM dbo.KHOA
UPDATE dbo.GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (SELECT TRGKHOA FROM dbo.KHOA)
/* Câu 2: CÂU 2 CẬP NHẬT GIÁ TRỊ ĐIỂM TRUNG BÌNH TẤT CẢ MÔN HỌC CỦA MỖI HỌC VIÊN TẤT CẢ ĐIỂM ĐỀu CÓ HỆ SỐ 1 CHỈ
LẤY ĐIỂM LẦN THI SAU CÙNG */

UPDATE dbo.HOCVIEN
SET DIEMTB = ( 
		SELECT AVG(DIEM) -- Tính điểm trung bình
		FROM dbo.KETQUATHI
		WHERE LANTHI = ( SELECT MAX(LANTHI) -- Chọn lần thi lớn nhất
						 FROM dbo.KETQUATHI
						 WHERE MAHV = dbo.KETQUATHI.MAHV -- Các MAHV có trong KETQUATHI
						 GROUP BY MAHV ) -- Nhóm thành từng group
		GROUP BY MAHV
		HAVING MAHV = KETQUATHI.MAHV
		     )



/* Câu 3: CÂU 2 CẬP NHẬT GIÁ TRỊ ĐIỂM TRUNG BÌNH TẤT CẢ MÔN HỌC CỦA MỖI HỌC VIÊN TẤT CẢ ĐIỂM ĐỀu CÓ HỆ SỐ 1 CHỈ
LẤY ĐIỂM LẦN THI SAU CÙNG */
UPDATE dbo.HOCVIEN
SET GHICHU = 'CAMTHI'
WHERE EXISTS(SELECT * FROM dbo.KETQUATHI
				WHERE ( LANTHI = '3' AND DIEM < 5 ))

-- Câu 4: Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN như sau: 
-- Nếu DIEMTB >= 9 thì XEPLOAI = ”XS”
-- Nếu 8 <= DIEMTB < 9 thì XEPLOAI = “G”
-- Nếu 6.5 <= DIEMTB < 8 thì XEPLOAI = “K”
-- Nếu 5 <= DIEMTB < 6.5 thì XEPLOAI = “TB” 
-- Nếu DIEMTB < 5 thì XEPLOAI = ”Y” 

-- Cách 1:
UPDATE dbo.HOCVIEN
SET XEOLOAI = 'XS'
WHERE DIEMTB >= 9

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'G'
WHERE 8 <= DIEMTB AND DIEMTB < 9

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'K'
WHERE 6.5 <= DIEMTB AND DIEMTB < 8

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'TB'
WHERE 5 <= DIEMTB AND DIEMTB < 6.5

UPDATE dbo.HOCVIEN
SET XEOLOAI = 'Y'
WHERE DIEMTB < 5

-- Cách 2:
UPDATE dbo.HOCVIEN
SET XEOLOAI =
(
	CASE 
		WHEN DIEMTB >= 9 THEN 'XS'
		WHEN 8 <= DIEMTB AND DIEMTB < 9 THEN 'G'
		WHEN 6.5 <= DIEMTB AND DIEMTB < 8 THEN 'K'
		WHEN 5 <= DIEMTB AND DIEMTB < 6.5 THEN 'TB'
		WHEN DIEMTB < 5 THEN 'Y'
	END	
)

-- Phần 3 Ngôn ngữ truy vấn dữ liệu:

-- Câu 1: In ra danh sách (mã học viên, họ tên, ngày sinh, mã lớp) lớp trưởng của các lớp.
-- Cách 1:
SELECT MAHV,CONCAT(HO, ' ',TEN) AS HOTEN,NGSINH, dbo.HOCVIEN.MALOP 
FROM dbo.HOCVIEN,dbo.LOP
WHERE dbo.HOCVIEN.MAHV = dbo.LOP.TRGLOP

-- Cách 2:
SELECT MAHV, CONCAT(HO, ' ',TEN) AS HOTEN, NGSINH, dbo.HOCVIEN.MALOP
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON dbo.HOCVIEN.MAHV = dbo.LOP.TRGLOP

-- Cách 3:
SELECT MAHV,CONCAT(HO, ' ',TEN) AS HOTEN,NGSINH, dbo.HOCVIEN.MALOP 
FROM dbo.HOCVIEN
WHERE MAHV IN (SELECT TRGLOP FROM dbo.LOP)

-- Câu 2:In ra bảng điểm khi thi (mã học viên, họ tên , lần thi, điểm số) môn CTRR của lớp “K12”,
-- Sắp xếp theo tên, họ học viên.
-- Cách1
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN,LANTHI, DIEM
FROM dbo.HOCVIEN,dbo.KETQUATHI
WHERE MAMH = 'CTRR' AND dbo.HOCVIEN.MALOP = 'K12' AND dbo.HOCVIEN.MAHV = dbo.KETQUATHI.MAHV
ORDER BY HO,TEN 

-- Cách 2
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN,LANTHI, DIEM
FROM dbo.KETQUATHI
INNER JOIN dbo.HOCVIEN ON dbo.KETQUATHI.MAHV = dbo.HOCVIEN.MAHV
WHERE MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY TEN, HO

--Câu 3: In ra danh sách những học viên (mã học viên, họ tên) và những môn học mà học viên đó thi
--lần thứ nhất đã đạt.

SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN, dbo.MONHOC.TENMH
FROM dbo.KETQUATHI
INNER JOIN dbo.MONHOC ON dbo.MONHOC.MAMH = dbo.KETQUATHI.MAMH 
INNER JOIN  dbo.HOCVIEN ON dbo.KETQUATHI.MAHV = dbo.HOCVIEN.MAHV 
WHERE LANTHI = '1' AND KQUA = N'Đạt'

--Câu 4: In ra danh sách học viên (mã học viên, họ tên) của lớp “K11” thi môn CTRR không đạt (ở
--lần thi 1).

SELECT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE dbo.HOCVIEN.MALOP = 'K11' AND LANTHI = '1' AND KQUA = N'Không Đạt'


--------------------------------------------------------------------- BUỔI 3 ----------------------------------------------------------------------------- 
-- 20/10/2021

-- Phần 3

/*Câu 5: * Danh sách học viên (mã học viên, họ tên) của lớp “K” thi môn CTRR không đạt (ở tất cả
các lần thi). */

-- Cách 1: theo hướng hiểu thứ nhất
SELECT DISTINCT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' AND KQUA = N'Không Đạt'

SELECT  dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' AND KQUA = N'Không Đạt'

-- Cách 2:

SELECT  dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' 
AND NOT EXISTS ( SELECT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
			     INNER JOIN dbo.HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
				 WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' AND KQUA = N'Đạt')

-- Cách 3:
SELECT  dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' 
AND HOCVIEN.MAHV IN (SELECT DISTINCT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
					  WHERE MAHV = 'CTRR' AND KQUA = N'Không Đạt') 
										  AND dbo.KETQUATHI.MAHV NOT IN ( SELECT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
																		 WHERE MAMH = 'CTRR' AND KQUA = N'Đạt' AND LANTHI >=2)

-- Cách 4:

SELECT DISTINCT dbo.HOCVIEN.MAHV, CONCAT(HO, ' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE SUBSTRING(MALOP,1,1) = 'K' AND MAMH = 'CTRR' 
AND HOCVIEN.MAHV NOT IN (SELECT dbo.KETQUATHI.MAHV FROM dbo.KETQUATHI
INNER JOIN dbo.HOCVIEN ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE MAMH = 'CTRR' AND KQUA = NN'Đạt' AND LANTHI >= 2 )

-- Cách 5:

SELECT DISTINCT MAHV
FROM dbo.KETQUATHI
WHERE MAMH = 'CTRR' AND KQUA = N'Không Đạt'
EXCEPT
SELECT DISTINCT MAHV
FROM dbo.KETQUATHI
WHERE MAMH = 'CTRR' AND	 KQUA = N'Đạt' AND LANTHI >= 2



/*Câu 6:Tìm tên những môn học mà giáo viên có tên “Tran Tam Thanh” dạy trong học kỳ 1 năm
2006.*/		

SELECT DISTINCT dbo.MONHOC.MAMH
FROM dbo.MONHOC
INNER JOIN dbo.GIANGDAY ON dbo.MONHOC.MAMH = dbo.GIANGDAY.MAMH
INNER JOIN dbo.GIAOVIEN ON	GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = N'Trần Tam Thanh' AND HOCKY = 1 AND NAM = 2006


-- Làm thêm các lớp và GV Trần Tam Thanh đã dạy HK1 năm 2006
SELECT *
FROM dbo.MONHOC
INNER JOIN dbo.GIANGDAY ON dbo.MONHOC.MAMH = dbo.GIANGDAY.MAMH
INNER JOIN dbo.GIAOVIEN ON	GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = N'Trần Tam Thanh' AND HOCKY = 1 AND NAM = 2006

/*Câu 7:Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy
trong học kỳ 1 năm 2006.*/


SELECT dbo.MONHOC.MAMH, dbo.MONHOC.TENMH
FROM dbo.MONHOC
INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAMH = MONHOC.MAMH INNER JOIN dbo.LOP ON LOP.MALOP = GIANGDAY.MALOP
WHERE MAGV = (SELECT MAGVCN FROM dbo.LOP WHERE MALOP = 'K11')  AND HOCKY = 1 AND NAM = 2006


/*Câu 8:Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So
Du Lieu”.*/
--not yet
SELECT CONCAT(HO, ' ', TEN) AS HOTEN
FROM dbo.HOCVIEN
WHERE MAHV IN (
	SELECT TRGLOP 
	FROM dbo.LOP
	INNER JOIN dbo.GIANGDAY ON GIANGDAY.MALOP = LOP.MALOP -- kết bảng GIANGDAY và LOP
	INNER JOIN dbo.GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV-- kết bảng GIANGDAY và GIAOVIEN
	INNER JOIN dbo.MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH -- kết bảng MONHOC và GIANGDAY
	WHERE HOTEN = N'Nguyễn Tố Lan' AND TENMH = N'Cơ sở dữ liệu')
						
						
/*Câu 9: In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So
Du Lieu”.*/
SELECT MAMH, TENMH
FROM dbo.MONHOC
WHERE dbo.MONHOC.MAMH IN (SELECT MAMH_TRUOC
						  FROM dbo.DIEUKIEN
						  INNER JOIN dbo.MONHOC ON MONHOC.MAMH = DIEUKIEN.MAMH -- kết bảng MONHOC và DIEUKIEN
						  WHERE TENMH = N'Cơ sở dữ liệu') 


/*Câu 10: Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học,
tên môn học) nào.*/

SELECT MAMH, TENMH
FROM dbo.MONHOC
WHERE dbo.MONHOC.MAMH IN (SELECT dbo.DIEUKIEN.MAMH
						  FROM dbo.DIEUKIEN
						  INNER JOIN dbo.MONHOC ON MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC -- kết bảng MONHOC và DIEUKIEN
						  WHERE TENMH = N'Cấu trúc rời rạc') 




/*Câu 11: Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1
năm 2006.*/

SELECT HOTEN
FROM dbo.GIAOVIEN
WHERE MAGV IN (
	SELECT GIAOVIEN.MAGV
	FROM dbo.GIAOVIEN
	INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV -- kết bảng GIANGDAY và GIAOVIEN
	WHERE MALOP = 'K11' AND HOCKY = 1 AND NAM = 2006
	UNION
	SELECT GIAOVIEN.MAGV
	FROM dbo.GIAOVIEN
	INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV -- kết bảng GIANGDAY và GIAOVIEN
	WHERE MALOP = 'K12' AND HOCKY = 1 AND NAM = 2006
)

/*Câu 12: Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng
chưa thi lại môn này.*/

-- Cách 1:
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS	HOTEN
FROM dbo.HOCVIEN 
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
WHERE MAMH = 'CSDL' AND KQUA = N'Không Đạt' AND LANTHI <= 1 AND NOT EXISTS (SELECT * FROM dbo.KETQUATHI
																			INNER JOIN dbo.HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV -- kết bảng KETQUATHI và HOCVIEN
																			WHERE LANTHI > 1
																			)
-- Cách 2:
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS	HOTEN -- Gộp HO và TEN ở giữa có khoảng trắng
FROM dbo.HOCVIEN 
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
WHERE MAMH = 'CSDL' AND KQUA = N'Không Đạt' AND LANTHI = 1
EXCEPT
SELECT dbo.HOCVIEN.MAHV, CONCAT(HO,' ',TEN) AS	HOTEN
FROM dbo.HOCVIEN 
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
WHERE MAMH = 'CSDL'AND KQUA = N'Không Đạt' AND LANTHI > 1

/*Câu 13: Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào.*/

SELECT MAGV, HOTEN
FROM dbo.GIAOVIEN
WHERE MAGV IN (SELECT DISTINCT MAGV
			   FROM dbo.GIAOVIEN
			   EXCEPT
			   SELECT DISTINCT MAGV
			   FROM dbo.GIANGDAY)

/*Câu 14: Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào
thuộc khoa giáo viên đó phụ trách.*/
SELECT MAGV, HOTEN
FROM dbo.GIAOVIEN
WHERE NOT EXISTS(SELECT * -- chọn các giáo viên được phân công giảng dạy bất kỳ môn học nào thuộc khoa giáo viên đó phụ trách
				 FROM dbo.MONHOC,dbo.GIANGDAY
				 WHERE dbo.MONHOC.MAKHOA = dbo.GIAOVIEN.MAKHOA
				 AND dbo.GIANGDAY.MAGV = dbo.GIAOVIEN.MAGV
				 AND dbo.GIANGDAY.MAMH = dbo.MONHOC.MAMH
				 )

/*Câu 15: Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat”
hoặc thi lần thứ 2 môn CTRR được 5 điểm.*/

SELECT CONCAT(HO,' ',TEN) AS HOTEN
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON LOP.MALOP = HOCVIEN.MALOP -- kết bảng LOP và HOCVIEN
WHERE SUBSTRING(HOCVIEN.MALOP,1,3) = 'K11' AND MAHV IN (SELECT dbo.HOCVIEN.MAHV 
										 FROM dbo.HOCVIEN
										 INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
										 WHERE LANTHI > 3 AND KQUA = N'Không Đạt'
										 UNION
									     SELECT dbo.HOCVIEN.MAHV 
										 FROM dbo.HOCVIEN
										 INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
										 WHERE MAMH = 'CTRR' AND LANTHI = 2 AND KQUA = N'Đạt')
/*Câu 16: Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm
học.*/

SELECT HOTEN
FROM dbo.GIAOVIEN
WHERE dbo.GIAOVIEN.MAGV IN (SELECT dbo.GIAOVIEN.MAGV
						    FROM dbo.GIAOVIEN
							INNER JOIN dbo.GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV -- kết bảng GIANGDAY và GIAOVIEN
							WHERE dbo.GIANGDAY.MAMH = 'CTRR' 
							GROUP BY dbo.GIAOVIEN.MAGV, HOCKY, NAM
							HAVING COUNT(MALOP) >= 2 )

/*Câu 17: Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng).*/

SELECT *
FROM dbo.KETQUATHI
INNER JOIN dbo.HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV -- kết bảng HOCVIEN và KETQUATHI
WHERE MAMH = 'CSDL' AND  LANTHI = ( SELECT MAX(LANTHI)
									FROM dbo.KETQUATHI
									WHERE MAMH = 'CSDL' AND dbo.KETQUATHI.MAHV = dbo.HOCVIEN.MAHV 
									GROUP BY KETQUATHI.MAHV
								  )
					

/*Câu 18: Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần
thi).*/

SELECT *
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV -- kết bảng KETQUATHI và HOCVIEN
INNER JOIN dbo.MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH -- kết bảng MONHOC và KETQUATHI
WHERE TENMH = N'Cơ sở dữ liệu' 
	  AND DIEM = 
	  (
		  SELECT MAX(DIEM) -- Chọn điểm thi cao nhất
		  FROM dbo.KETQUATHI
		  WHERE TENMH = N'Cơ sở dữ liệu' AND dbo.HOCVIEN.MAHV = dbo.KETQUATHI.MAHV -- kết KETQUATHI.MAHV với HOCVIEN.MAHV ở câu lệnh trước đó
		  GROUP BY dbo.KETQUATHI.MAHV
	   )

--phép chia
/*
SELECT *
FROM    dbo.GIANGDAY
ORDER BY MAGV

SELECT *
FROM    dbo.LOP

SELECT * FROM dbo.GIAOVIEN
WHERE NOT EXISTS (
SELECT dbo.LOP.MALOP FROM    dbo.LOP
EXCEPT
SELECT dbo.GIANGDAY.MALOP FROM dbo.GIANGDAY
WHERE dbo.GIAOVIEN.MAGV = dbo.GIANGDAY.MAGV)
*/

--------------------------------------------------------------------- BUỔI 4 ----------------------------------------------------------------------------- 
-- 03/11/2021

-- Phần 3

/*Câu 19:Khoa nào (mã khoa, tên khoa) được thành lập sớm nhất.*/
-- Bảng : KHOA

-- Cách1
USE uit_qlgv

SELECT MAKHOA, NGTLAP
FROM dbo.KHOA
WHERE MONTH(NGTLAP) = (SELECT MIN(MONTH(NGTLAP)) -- chọn tháng bé nhất
					   FROM dbo.KHOA)
	  AND	

	  DAY(NGTLAP) = (SELECT MIN(DAY(NGTLAP)) -- chọn ngày bé nhất
					   FROM dbo.KHOA)

	  AND	

	  YEAR(NGTLAP) = (SELECT MIN(YEAR(NGTLAP)) -- chọn năm bé nhất
					   FROM dbo.KHOA)

-- Cách2

SELECT MAKHOA, NGTLAP
FROM dbo.KHOA
WHERE NGTLAP = (SELECT MIN(NGTLAP)
			    FROM dbo.KHOA)

/*Câu 20: Có bao nhiêu (thống kê) giáo viên có học hàm là “GS” hoặc “PGS”.*/
-- Bảng: GIAOVIEN	

--Cách 1:
SELECT HOCHAM,COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM = 'GS' OR HOCHAM = 'PGS'
GROUP BY HOCHAM

--Cách 2:
SELECT COUNT(MAGV), HOCHAM
FROM dbo.GIAOVIEN
WHERE HOCHAM = 'GS' 
GROUP BY HOCHAM
UNION
SELECT COUNT(MAGV), HOCHAM
FROM dbo.GIAOVIEN
WHERE  HOCHAM = 'PGS'
GROUP BY HOCHAM

--Cách 3:
SELECT HOCHAM,COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM IN ('PGS', 'GS')
GROUP BY HOCHAM

-- Làm thêm: (Thống kê) có bao nhiêu giảng viên chưa là GS, PSG

--Cách 1:
SELECT COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM NOT IN ('PGS', 'GS')


--Cách 2:
SELECT SUM(SOLUONG) AS NOT_PGS_GS_nef
FROM	
(SELECT HOCHAM, COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
WHERE HOCHAM IN ('Null', 'GV')
GROUP BY HOCHAM) AS NOT_PGS_GS

/*Câu 21: Thống kê có bao nhiêu giáo viên có học vị là “CN”, “KS”, “Ths”, “TS”, “PTS” trong mỗi
khoa.*/
-- Bảng: KHOA, GIAOVIEN

SELECT dbo.KHOA.MAKHOA,TENKHOA,HOCVI,COUNT(MAGV) AS SOLUONG
FROM dbo.GIAOVIEN
INNER JOIN dbo.KHOA ON KHOA.MAKHOA = GIAOVIEN.MAKHOA
WHERE HOCVI IN ('CN', 'KS', 'Ths', 'TS', 'PTS')
GROUP BY dbo.KHOA.MAKHOA,TENKHOA,HOCVI

-- Làm thêm: Cập nhật PTS thành TS, TS thành TSKH
UPDATE dbo.GIAOVIEN
SET HOCVI = 'TSKH'
WHERE HOCVI = 'TS'

UPDATE dbo.GIAOVIEN
SET HOCVI = 'TS'
WHERE HOCVI = 'PTS'

SELECT * FROM dbo.GIAOVIEN
-- Làm thêm:

/*Câu 22: Mỗi môn học thống kê số lượng học viên theo kết quả (đạt và không đạt).*/

-- Bảng: KETQUATHI

SELECT TENMH,KQUA ,COUNT(MAHV) AS SOLUONG
FROM dbo.KETQUATHI
INNER JOIN dbo.MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH
GROUP BY KQUA,TENMH



/*Câu 23: Tìm giáo viên (mã giáo viên, họ tên) là giáo viên chủ nhiệm của một lớp, đồng thời dạy cho
lớp đó ít nhất một môn học.*/

--Bảng : GIAOVIEN,LOP,GIANGDAY

SELECT MAGV,HOTEN
FROM dbo.GIAOVIEN
INNER JOIN dbo.LOP ON LOP.MAGVCN = GIAOVIEN.MAGV
WHERE EXISTS (SELECT * 
			  FROM dbo.GIANGDAY
			  WHERE dbo.GIANGDAY.MAGV = dbo.GIAOVIEN.MAGV
			    AND dbo.GIANGDAY.MALOP = dbo.LOP.MALOP
			  )

/*Câu 24: Tìm họ tên lớp trưởng của lớp có sỉ số cao nhất.*/

-- Bảng : LOP, HOCVIEN
SELECT CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON LOP.TRGLOP = HOCVIEN.MAHV
WHERE SISO = (SELECT MAX(SISO) FROM dbo.LOP)


/*Câu 25: Tìm họ tên những LOPTRG thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả
các lần thi).*/
-- bảng: KETQUATHI, HOCVIEN, LOP
SELECT CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.LOP ON LOP.TRGLOP = HOCVIEN.MAHV
WHERE MAHV IN
(	SELECT MAHV
	FROM (
		SELECT MAHV, MAMH
		FROM dbo.KETQUATHI
		WHERE KQUA = N'Không Đạt'
		EXCEPT
		SELECT MAHV, MAMH
		FROM dbo.KETQUATHI
		WHERE KQUA = N'Đạt' AND LANTHI >= 2 
		) AS TA
		GROUP BY MAHV
		HAVING COUNT(TA.MAHV) > 3
)

-- 25.1/*Câu 25: Tìm họ tên những HOCVIEN thi không đạt quá 3 môn (mỗi môn đều thi không đạt ở tất cả
--các lần thi).*/

SELECT CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
WHERE MAHV IN ( SELECT MAHV, COUNT(MAHV)
				FROM(
				SELECT MAHV, MAMH
				FROM dbo.KETQUATHI
				WHERE KQUA = N'Không Đạt'
				EXCEPT
				SELECT MAHV, MAMH
				FROM dbo.KETQUATHI
				WHERE KQUA = N'Đạt' AND LANTHI >= 2
				) AS T
				GROUP BY MAHV
				HAVING COUNT(T.MAHV) > 3
				)


SELECT HO + ' ' + TEN -- 'HỌ TÊN TRƯỞNG LỚP THI KHÔNG ĐẠT QUÁ 3 MÔN'
FROM
	HOCVIEN, LOP, KETQUATHI
WHERE
	HOCVIEN.MAHV = LOP.TRGLOP
	AND HOCVIEN.MAHV = KETQUATHI.MAHV
	AND KQUA = N'Không Đạt'
GROUP BY 
	TRGLOP, HO, TEN
HAVING 
	COUNT(*) > 3

/*Câu 26: Tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.*/

SELECT HOCVIEN.MAHV, CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
WHERE MAHV IN (SELECT MAHV 
			   FROM dbo.KETQUATHI	
			   WHERE DIEM = 9 OR DIEM = 10
			   GROUP BY MAHV
			   HAVING COUNT(DIEM) = (
									SELECT MAX(SLDIEM)
									FROM(SELECT MAHV, COUNT(DIEM) AS SLDIEM
										 FROM dbo.KETQUATHI
										 WHERE DIEM = 9 OR DIEM = 10
										 GROUP BY MAHV
									) AS T
									)
				)
/*Câu 27: Trong từng lớp, tìm học viên (mã học viên, họ tên) có số môn đạt điểm 9,10 nhiều nhất.*/
SELECT B.MALOP, A.MAHV, HO, TEN
FROM dbo.KETQUATHI A, dbo.HOCVIEN B
WHERE A.MAHV = B.MAHV AND (A.DIEM = 9 OR A.DIEM = 10)
GROUP BY B.MALOP, A.MAHV, HO, TEN
HAVING COUNT(MAMH) >= ALL(SELECT COUNT(A.MAMH)
						  FROM	dbo.KETQUATHI C, dbo.HOCVIEN D
						  WHERE C.MAHV = D.MAHV AND B.MALOP = D.MALOP AND (DIEM = 9 OR DIEM = 10)
						  GROUP BY C.MAHV
						)

/*Câu 28: Trong từng học kỳ của từng năm, mỗi giáo viên phân công dạy bao nhiêu môn học, bao
nhiêu lớp.*/

SELECT NAM, HOCKY, MAGV,COUNT(MAMH) AS SL_MONHOC, COUNT(MALOP) AS SL_LOP
FROM dbo.GIANGDAY
GROUP BY HOCKY,NAM,MAGV

/*Câu 29: Trong từng học kỳ của từng năm, tìm giáo viên (mã giáo viên, họ tên) giảng dạy nhiều nhất.*/
SELECT MAGV, HOTEN
FROM dbo.GIAOVIEN
WHERE MAGV IN (SELECT MAGV 
				FROM(SELECT NAM, HOCKY, MAGV,COUNT(MAMH) AS SL_MONHOC, COUNT(MALOP) AS SL_LOP
										 FROM dbo.GIANGDAY
										 GROUP BY HOCKY,NAM,MAGV
									     ) AS A
				WHERE SL_MONHOC = (
									 SELECT MAX(SL_MONHOC)
									 FROM(SELECT NAM, HOCKY, MAGV,COUNT(MAMH) AS SL_MONHOC, COUNT(MALOP) AS SL_LOP
										 FROM dbo.GIANGDAY
										 GROUP BY HOCKY,NAM,MAGV
									     ) AS T
									)
			   )


/*Câu 30: Tìm môn học (mã môn học, tên môn học) có nhiều học viên thi không đạt (ở lần thi thứ 1) nhất
nhất.*/
SELECT KQ.MAMH, TENMH, COUNT(KQ.MAMH) AS SL
FROM dbo.KETQUATHI KQ, dbo.MONHOC MH
WHERE KQ.MAMH = MH.MAMH AND KQ.KQUA = N'Không Đạt' AND KQ.LANTHI = 1
GROUP BY KQ.MAMH, MH.TENMH

HAVING COUNT(KQ.MAMH) >= ALL(SELECT COUNT(MAHV)
							FROM dbo.KETQUATHI
							WHERE KQUA = N'Không Đạt' AND LANTHI = 1
							GROUP BY MAMH
							)

/*Câu 31: Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi thứ 1).*/

SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI
							WHERE KQUA = N'Không Đạt' AND LANTHI = 1 AND dbo.KETQUATHI.MAHV = MAHV)

/*Câu 32: * Tìm học viên (mã học viên, họ tên) thi môn nào cũng đạt (chỉ xét lần thi sau cùng).*/
SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI T1
							WHERE KQUA = N'Không Đạt' AND LANTHI = (SELECT MAX(LANTHI)
																	FROM dbo.KETQUATHI T2 
																	WHERE T1.MAHV = T2.MAHV
																	)

							AND dbo.KETQUATHI.MAHV = MAHV)


/*Câu 33: * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi thứ 1).*/

SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI
							WHERE KQUA = N'Không Đạt' AND LANTHI = 1 AND dbo.KETQUATHI.MAHV = MAHV)

/*Câu 34: * Tìm học viên (mã học viên, họ tên) đã thi tất cả các môn đều đạt (chỉ xét lần thi sau cùng).*/
SELECT DISTINCT dbo.HOCVIEN.MAHV,CONCAT(HO, ' ', TEN)
FROM dbo.HOCVIEN
INNER JOIN dbo.KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE HOCVIEN.MAHV NOT IN (SELECT MAHV 
							FROM dbo.KETQUATHI T1
							WHERE KQUA = N'Không Đạt' AND LANTHI = (SELECT MAX(LANTHI)
																	FROM dbo.KETQUATHI T2 
																	WHERE T1.MAHV = T2.MAHV
																	)

							AND dbo.KETQUATHI.MAHV = MAHV)

/*Câu 35: ** Tìm học viên (mã học viên, họ tên) có điểm thi cao nhất trong từng môn (lấy điểm ở lần
thi sau cùng).*/
SELECT MaMH, MaHV, HoTen
FROM
(
	SELECT
		MaMH, HocVien.MaHV, (Ho+' '+Ten) HoTen, RANK() OVER (PARTITION BY MaMH ORDER BY MAX(Diem) DESC) AS XepHang
	FROM
		HocVien, KetQuaThi
	WHERE
		HocVien.MaHV = KetQuaThi.MaHV
		AND LanThi = (SELECT MAX(LanThi) FROM KetQuaThi WHERE MaHV = HocVien.MaHV GROUP BY MaHV)
	GROUP BY
		MaMH, HocVien.MaHV, Ho, Ten
) AS A
WHERE XepHang = 1

--------------------------------------------------------------------- BUỔI 5 ----------------------------------------------------------------------------- 
--17/11/2021
-- Phần 1:
/*Câu 5: Kết quả thi là “Dat” nếu điểm từ 5 đến 10 và “Khong dat” nếu điểm nhỏ hơn 5.*/
-- Bảng: KETQUATHI

ALTER TABLE dbo.KETQUATHI
ADD CONSTRAINT CHK_KQUA CHECK ((KQUA = N'Đạt' AND DIEM >= 5) OR (KQUA = N'Không Đạt' AND DIEM < 5))


/*Câu 6: Học viên thi một môn tối đa 3 lần.*/
-- Bảng: KETQUATHI
ALTER TABLE dbo.KETQUATHI
ADD CONSTRAINT CHECK_LANTHI CHECK (LANTHI <= 3)

/*Câu 7: Học kỳ chỉ có giá x`trị từ 1 đến 3.*/
-- Bảng: GIANGDAY
ALTER TABLE dbo.GIANGDAY
ADD CONSTRAINT CHECK_HOCKY CHECK (HOCKY BETWEEN 1 AND 3)

/*Câu 8: Học vị của giáo viên chỉ có thể là “CN”, “KS”, “Ths”, ”TS”, ”PTS”.*/
-- Bảng: GIAOVIEN

ALTER TABLE dbo.GIAOVIEN
ADD CONSTRAINT CHECK_HOCVI CHECK (HOCVI = 'CN' OR HOCVI = 'KS' OR HOCVI = 'Ths' OR HOCVI = 'TS' OR HOCVI = 'PTS')

ALTER TABLE dbo.GIAOVIEN
ADD CONSTRAINT CHECK_HOCVIne CHECK (HOCVI IN ('CN','KS','Ths','TS','PTS'))

/*Câu 9: Lớp trưởng của một lớp phải là học viên của lớp đó.*/
-- INSERT, UPDATE

DECLARE @TEN_BIEN INT, @CHUOI VARCHAR(20);
DECLARE @BIEN INT = 20;

SET @TEN_BIEN = 10;

PRINT 'Hello';
PRINT ('Hello');
PRINT @BIEN
PRINT @TEN_BIEN

CREATE TRIGGER TRG_LOP_LOPTRUONG
ON LOP
FOR INSERT,UPDATE
AS
BEGIN 
	DECLARE @MAHV CHAR(5), @TRGLOP CHAR(5), @MALOP CHAR(3)
	
	SELECT @TRGLOP = TRGLOP, @MALOP = MALOP
	FROM inserted

	SELECT @MAHV = MAHV
	FROM dbo.HOCVIEN
	WHERE MAHV = @TRGLOP AND @MALOP = MALOP

	IF (@MAHV <> @TRGLOP)
		BEGIN	
			PRINT 'Đã xãy ra lỗi. Lớp trưởng phải là thành viên của lớp '
			ROLLBACK TRANSACTION -- sử dụng để trao trả Transaction về trạng thái trước khi có thay đổi mà chưa được lưu tới Database
		END
	ELSE	
		PRINT 'Thành Công'
END

/*Câu 10: Trưởng khoa phải là giáo viên thuộc khoa và có học vị “TS” hoặc “PTS”.*/
-- INSERT, UPDATE
-- bảng: KHOA, GIAOVIEN

CREATE TRIGGER TRG_GIAOVIEN_TRUONGKHOA
ON KHOA
FOR INSERT, UPDATE
AS
BEGIN 
	DECLARE	@MAGV CHAR(4), @MAKHOA CHAR(4), @TRG_KHOA CHAR(4)

	SELECT @MAKHOA = MAKHOA, @TRG_KHOA = TRGKHOA
	FROM inserted

	SELECT @MAGV = MAGV
	FROM dbo.GIAOVIEN
	WHERE MAKHOA = @MAKHOA AND MAGV = @TRG_KHOA AND HOCVI IN ('TS', 'TSKH')

	IF (@MAGV <> @TRG_KHOA)
		BEGIN
			PRINT 'Xảy ra lỗi. Trưởng khoa phải là GV của Khoa và có học vị là TS hoặ TSKH'
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT'Thành công'
END

/*Câu 11: Học viên ít nhất là 18 tuổi.*/
-- Bảng: HOCVIEN
-- N0w - NGSINH >= 18

ALTER TABLE dbo.HOCVIEN
ADD CONSTRAINT CHECK_TUOIne CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 18)


SELECT YEAR(GETDATE()) - YEAR(NGSINH)
FROM dbo.HOCVIEN


/*Câu 12: Giảng dạy một môn học ngày bắt đầu (TUNGAY) phải nhỏ hơn ngày kết thúc
(DENNGAY).*/
ALTER TABLE dbo.GIANGDAY
ADD CONSTRAINT CHECK_GIANGDAY CHECK(TUNGAY < DENNGAY)


/*Câu 13: Giáo viên khi vào làm ít nhất là 22 tuổi.*/
-- Bảng: HOCVIEN
-- N0w - NGSINH >= 22
ALTER TABLE dbo.GIAOVIEN
ADD CONSTRAINT CHECK_TUOIGV CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 22)

SELECT HOTEN,YEAR(GETDATE()) - YEAR(NGSINH)
FROM dbo.GIAOVIEN
/*Câu 14: Tất cả các môn học đều có số tín chỉ lý thuyết và tín chỉ thực hành chênh lệch nhau không
quá 3.*/


ALTER TABLE dbo.MONHOC
ADD CONSTRAINT CHECK_TINCHI CHECK(abs(TCLT - TCTH) <= 3)

SELECT TCLT , TCTH, abs(TCTH - TCLT)
FROM dbo.MONHOC


/*15. Học viên chỉ được thi một môn học nào đó khi lớp của học viên đã học xong môn học này.*/
-- KETQUATHI*, GIANGDAY
-- NGTHI < NGKT

CREATE TRIGGER TRG_HV_THI
ON KETQUATHI
FOR INSERT
AS
BEGIN
	DECLARE @MAHV CHAR(5), @MALOP CHAR(3), @MAMH CHAR(10), @NGKT SMALLDATETIME, @NGTHI SMALLDATETIME
	
	SELECT @MAHV = inserted.MAHV, @MAMH = MAMH, @MALOP = MALOP, @NGTHI = TGTHI
	FROM inserted
	INNER JOIN	dbo.HOCVIEN ON inserted.MAHV = dbo.HOCVIEN.MAHV

	SELECT @NGKT = DENNGAY
	FROM dbo.GIANGDAY
	WHERE MALOP = @MALOP AND MAMH = @MAMH

	IF (@NGTHI > @NGKT)
		BEGIN	
			PRINT 'Ngày thi phải lớn hơn ngày kết thúc môn học'
			ROLLBACK TRANSACTION
		END
	ELSE	
		PRINT('Thành công')
END

/*16. Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.*/
-- GIANGDAY
CREATE TRIGGER HK_MONHOC_TOIDA
ON GIANGDAY
FOR INSERT,  UPDATE
AS
BEGIN
	DECLARE @MALOP CHAR(3),  @HOCKY TINYINT, @NAM SMALLINT, @SOLUONG INT
	SELECT @MALOP = MALOP, @HOCKY = HOCKY, @NAM = NAM
	FROM INSERTED

	SELECT @SOLUONG = COUNT(*)
	FROM dbo.GIANGDAY
	WHERE MALOP = @MALOP AND NAM = @NAM AND HOCKY = @HOCKY
	IF (@SOLUONG > 3)
		BEGIN
			PRINT(N'Mỗi học kỳ của một năm học, một lớp chỉ được học tối đa 3 môn.')
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT(N'THÀNH CÔNG')
END
/*17. Sỉ số của một lớp bằng với số lượng học viên thuộc lớp đó.*/
CREATE TRIGGER TRG_SISO ON HOCVIEN
FOR INSERT 
AS 
BEGIN
	UPDATE dbo.LOP SET	SISO = SISO + 1 FROM	dbo.LOP, inserted WHERE inserted.MALOP = dbo.LOP.MALOP
END

CREATE TRIGGER TRG_SS_DELETE ON HOCVIEN
FOR DELETE	 
AS 
BEGIN
	UPDATE dbo.LOP SET	SISO = SISO - 1 FROM	dbo.LOP, inserted WHERE inserted.MALOP = dbo.LOP.MALOP
END

CREATE TRIGGER TRG_SS_UPDATE ON HOCVIEN
FOR UPDATE		 
AS 
BEGIN
	UPDATE dbo.LOP SET	SISO = SISO + 1 FROM	dbo.LOP, inserted WHERE inserted.MALOP = dbo.LOP.MALOP
	UPDATE dbo.LOP SET	SISO = SISO - 1 FROM	dbo.LOP, deleted WHERE deleted.MALOP = dbo.LOP.MALOP

END

/*18. Trong quan hệ DIEUKIEN giá trị của thuộc tính MAMH và MAMH_TRUOC trong cùng
một bộ không được giống nhau (“A”,”A”) và cũng không tồn tại hai bộ (“A”,”B”) và
(“B”,”A”).*/
-- DIEUKIEN
CREATE TRIGGER TG_DIEUKIEN
ON DIEUKIEN
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @MAMH VARCHAR(10), @MAMH_TRUOC VARCHAR(10)

	SELECT @MAMH = MAMH, @MAMH_TRUOC = MAMH_TRUOC
	FROM INSERTED

	IF (@MAMH_TRUOC = @MAMH) OR EXISTS (SELECT * FROM dbo.DIEUKIEN WHERE MAMH = @MAMH_TRUOC)
		BEGIN
			PRINT(N'Trong quan hệ DIEUKIEN giá trị của thuộc tính MAMH và MAMH_TRUOC trong cùng một bộ không được giống nhau (“A”,”A”) và cũng không tồn tại hai bộ (“A”,”B”) và (“B”,”A”).')
			ROLLBACK TRANSACTION
		END
	ELSE PRINT(N'THÀNH CÔNG')
END
/*19. Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau.*/
--GIAOVIEN
CREATE TRIGGER TRG_LUONG
ON GIAOVIEN
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @HOCVI NVARCHAR(10), @HOCHAM NVARCHAR(10),  @HESO1 NUMERIC(4,2),@HESO2 NUMERIC(4,2)

	SELECT @HOCVI = HOCVI, @HOCHAM = HOCHAM, @HESO1 = HESO
	FROM INSERTED

	SELECT @HESO2 = HESO
	FROM dbo.GIAOVIEN
	WHERE @HOCVI = HOCVI AND @HOCHAM = HOCHAM
	
	IF (@HESO2 <> @HESO1)
		BEGIN
			PRINT('Các giáo viên có cùng học vị, học hàm, hệ số lương thì mức lương bằng nhau.')
			ROLLBACK TRANSACTION		
		END
	ELSE
		PRINT('THÀNH CÔNG')
END
/*20. Học viên chỉ được thi lại (lần thi > 1) khi điểm của lần thi trước đó dưới 5.*/
-- KETQUATHI
CREATE TRIGGER TRG_THILAI_DIEM
ON KETQUATHI
FOR INSERT,UPDATE
AS
BEGIN
	DECLARE @LANTHI TINYINT, @DIEM NUMERIC(18,0), @MAMH VARCHAR(10), @MAHV CHAR(5)

	SELECT @LANTHI = LANTHI, @DIEM = DIEM, @MAMH = MAMH, @MAHV = INSERTED.MAHV
	FROM INSERTED
	INNER JOIN dbo.HOCVIEN ON dbo.HOCVIEN.MAHV = INSERTED.MAHV
	IF (@LANTHI > 1)
	BEGIN
		SELECT @DIEM = DIEM FROM dbo.KETQUATHI WHERE LANTHI = @LANTHI - 1 AND @MAHV = MAHV AND @MAMH = MAMH
		IF(@DIEM > 5)
			BEGIN
				PRINT('Học viên chỉ được thi lại (lần thi > 1) khi điểm của lần thi trước đó dưới 5.')
				ROLLBACK TRANSACTION
		END
		ELSE
			PRINT('THÀNH CÔNG')
	END
END

/*21. Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước (cùng học viên, cùng môn
học).*/
-- KETQUATHI
CREATE TRIGGER TRG_THI
ON KETQUATHI
FOR INSERT,UPDATE
AS
BEGIN
	DECLARE @LANTHI TINYINT, @NGTHI_SAU SMALLDATETIME, @NGTHI_TRC SMALLDATETIME, @MAMH VARCHAR(10), @MAHV CHAR(5)

	SELECT @MAMH = MAMH, @MAHV = INSERTED.MAHV, @LANTHI = LANTHI
	FROM INSERTED
	INNER JOIN dbo.HOCVIEN ON dbo.HOCVIEN.MAHV = INSERTED.MAHV
	
	IF (@LANTHI > 1)
	BEGIN
		SELECT @NGTHI_TRC = TGTHI FROM dbo.KETQUATHI WHERE LANTHI = @LANTHI - 1 AND @MAHV = MAHV AND @MAMH = MAMH
		SELECT @NGTHI_SAU = TGTHI FROM dbo.KETQUATHI WHERE LANTHI = @LANTHI  AND @MAHV = MAHV AND @MAMH = MAMH
		IF(@NGTHI_SAU < @NGTHI_TRC)
			BEGIN
				PRINT('Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước (cùng học viên, cùng môn học)')
				ROLLBACK TRANSACTION
		END
		ELSE
			PRINT('THÀNH CÔNG')
	END
END
/*22. Học viên chỉ được thi những môn mà lớp của học viên đó đã học xong.*/
CREATE TRIGGER TRG_HV_THI1
ON KETQUATHI
FOR INSERT
AS
BEGIN
	DECLARE @MAHV CHAR(5), @MALOP CHAR(3), @MAMH CHAR(10), @NGKT SMALLDATETIME, @NGTHI SMALLDATETIME
	
	SELECT @MAHV = inserted.MAHV, @MAMH = MAMH, @MALOP = MALOP, @NGTHI = TGTHI
	FROM inserted
	INNER JOIN	dbo.HOCVIEN ON inserted.MAHV = dbo.HOCVIEN.MAHV

	SELECT @NGKT = DENNGAY
	FROM dbo.GIANGDAY
	WHERE MALOP = @MALOP AND MAMH = @MAMH

	IF (@NGTHI > @NGKT)
		BEGIN	
			PRINT 'Ngày thi phải lớn hơn ngày kết thúc môn học'
			ROLLBACK TRANSACTION
		END
	ELSE	
		PRINT('Thành công')
END

/*23. Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học (sau
khi học xong những môn học phải học trước mới được học những môn liền sau).*/

CREATE TRIGGER TRG_PHANCONG_GIANGDAY
ON GIANGDAY
FOR INSERT,UPDATE
AS
BEGIN
	DECLARE @MAMH VARCHAR(10), @MAMH_TRUOC VARCHAR(10)

	SELECT @MAMH = MAMH
	FROM INSERTED

	SELECT @MAMH_TRUOC = MAMH_TRUOC
	FROM dbo.DIEUKIEN
	WHERE MAMH = @MAMH

	IF NOT EXISTS (SELECT * FROM dbo.DIEUKIEN WHERE MAMH = @MAMH_TRUOC)
		BEGIN
			PRINT('Khi phân công giảng dạy một môn học, phải xét đến thứ tự trước sau giữa các môn học (sau khi học xong những môn học phải học trước mới được học những môn liền sau)')
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT('THÀNH CÔNG')
END
/*24. Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách.*/
-- GIANGDAY, GIAOVIEN, PHAN CONG

CREATE TRIGGER GV_PHANCONG_DAY
ON GIANGDAY
FOR INSERT
as
BEGIN 
	DECLARE @MAMH VARCHAR(10), @MAGV VARCHAR(10), @MAKHOAMH VARCHAR(4), @MAKHOAGV VARCHAR (4)

	SELECT @MAGV = MAGV,@MAMH = MAMH
	FROM INSERTED

	SELECT @MAKHOAMH = MAKHOA
	FROM dbo.MONHOC
	WHERE MAMH = @MAMH

	SELECT @MAKHOAGV = MAKHOA
	FROM dbo.GIAOVIEN
	WHERE MAGV = @MAGV

	IF (@MAKHOAGV <> @MAKHOAMH)
		BEGIN
			PRINT(N' Giáo viên chỉ được phân công dạy những môn thuộc khoa giáo viên đó phụ trách')
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT('THÀNH CÔNG')
END

--=====================

CREATE TRIGGER TRG_LOPTRUONG
ON LOP
FOR INSERT,UPDATE
AS
BEGIN
	DECLARE @TRGLOP CHAR(5), @MALOP1 CHAR(3), @MALOP2 CHAR(3), @MAHV CHAR(5)

	SELECT @TRGLOP = TRGLOP, @MALOP1 = MALOP, @MAHV = MAHV
	FROM INSERTED

	SELECT @MALOP2 = MALOP
	FROM dbo.HOCVIEN
	WHERE MAHV = @TRGLOP 

	IF(@MALOP2 <> @MALOP1)
		BEGIN
			PRINT(N'LIULIU')
			ROLLBACK TRANSACTION
		END
	ELSE
		PRINT(N'SUCCESS')
END

--=======================
SELECT HO,TEN
FROM dbo.HOCVIEN
WHERE MAHV IN 
(

)

SELECT MAHV
FROM dbo.KETQUATHI
WHERE KQUA = N'Không Đạt' 
EXCEPT 
SELECT MAHV
FROM dbo.KETQUATHI
WHERE KQUA = N'Đạt' AND LANTHI > 2
